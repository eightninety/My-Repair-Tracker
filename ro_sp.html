<?php
	require_once "includes/functions.php";

//  $cookie_user_info=$_COOKIE["user_info"];
//  if ($cookie_user_info=="")
//    {
//      include "includes/authorize_sp.html";
//    }
//  else
//    {
      include "includes/authorize_user.html";
//    }

  $errors=array();
  $error_found=FALSE;
  $dup_found=FALSE;
  $show_form=TRUE;
  $message="";
  $location=$BASE_HREF."ro_list.html?status=O";
	if ($ro_list_in_id)
		{
			$location.="&in_id=$ro_list_in_id";
		}
  if ($list_opened)
  	{
  		header("Location: $location");
  	}

  $location=$BASE_HREF."ro_list.html?status=C";
	if ($ro_list_in_id)
		{
			$location.="&in_id=$ro_list_in_id";
		}
  if ($list_closed)
  	{
  		header("Location: $location");
		}

	$reference_url = ENV_BASE_URL; // "http://dev.myrepairtracker.com";
	if ($lookup_company_url)
		{
			$reference_url="http://".$lookup_company_url;
		}
/*---------------------------------------------------------------*
 * 2Q 2007 Change: Provide ability to delete an RO for managers. *
 *---------------------------------------------------------------*/
  if (($lookup_user_is_admin) && ($delete_ro))
    {
/*------------------------------------------------------------------------*
 * 4Q 2010 Change: Copy RO that is about to be deleted to a backup table. *
 *------------------------------------------------------------------------*/
			$sql="INSERT INTO repair_order_deleted (id, date_inserted, date_added, date_arrived, date_updated, date_deleted, last_update_user_id, deleted_by_user_id, date_closed, date_report_card_completed, date_customer_status_checked, customer_page_count, status, unread_customer_msg, unread_feedback_msg, unread_insurance_msg, hot_file, hot_file_comment, fast_track, fast_track_comment, eom, eom_comment, multi_point_inspection, multi_point_inspection_comment, recall, assignment_id, appointment_id, from_cc, service_status, service_status_1, service_status_date_1, service_status_2, service_status_date_2, service_status_3, service_status_date_3, service_status_4, service_status_date_4, service_status_5, service_status_date_5, service_status_6, service_status_date_6, service_status_7, service_status_date_7, service_status_8, service_status_date_8, service_status_9, service_status_date_9, service_status_sub_step_1, service_status_sub_step_date_1, service_status_sub_step_2, service_status_sub_step_date_2, service_status_sub_step_3, service_status_sub_step_date_3, service_status_sub_step_4, service_status_sub_step_date_4, service_status_sub_step_5, service_status_sub_step_date_5, service_status_sub_step_6, service_status_sub_step_date_6, service_status_sub_step_7, service_status_sub_step_date_7, service_status_sub_step_8, service_status_sub_step_date_8, service_status_sub_step_9, service_status_sub_step_date_9, service_provider_id, repair_order_number, job_number, claim_number, insurance_assignment_id, service_provider_advisor_id, service_provider_body_tech_id, service_provider_paint_tech_id, service_provider_mech_tech_id, service_provider_trim_tech_id, vehicle_owner_first_name, vehicle_owner_last_name, vehicle_owner_primary_phone, vehicle_owner_secondary_phone, vehicle_owner_primary_email, vehicle_owner_secondary_email, vehicle_owner_email_allowed, vehicle_owner_texting_allowed, carrier_id, vehicle_year, vehicle_make_id, vehicle_model, vehicle_color, vehicle_mileage, vehicle_vin, vehicle_plate_no, vehicle_gone, vehicle_gone_date, vehicle_insurance_id, damage_assessment, vehicle_damage_id, vehicle_service_id, prior_damage_details, total_loss_charges, preliminary_repair_amount, revised_repair_amount, parts_total, parts_alternative, paint_materials, labor_dollars, scheduled_completion_date, revised_completion_date, labor_cycle_time, labor_weekends_holidays, labor_hours_body, labor_hours_paint, labor_hours_mech, labor_hours_trim, labor_hours_frame, labor_sublet, labor_actual_cycle_time, report_card_token, report_card_completed, report_card_a1, report_card_a2, report_card_a3, report_card_a4, report_card_a5, report_card_a6, report_card_a7, report_card_comments, report_card_yes_count, hail_damage, hail_damage_comment, EMS_UNQFILE_ID) (SELECT id, date_inserted, date_added, date_arrived, date_updated, NOW(), '$lookup_user_id', last_update_user_id, date_closed, date_report_card_completed, date_customer_status_checked, customer_page_count, status, unread_customer_msg, unread_feedback_msg, unread_insurance_msg, hot_file, hot_file_comment, fast_track, fast_track_comment, eom, eom_comment, multi_point_inspection, multi_point_inspection_comment, recall, assignment_id, appointment_id, from_cc, service_status, service_status_1, service_status_date_1, service_status_2, service_status_date_2, service_status_3, service_status_date_3, service_status_4, service_status_date_4, service_status_5, service_status_date_5, service_status_6, service_status_date_6, service_status_7, service_status_date_7, service_status_8, service_status_date_8, service_status_9, service_status_date_9, service_status_sub_step_1, service_status_sub_step_date_1, service_status_sub_step_2, service_status_sub_step_date_2, service_status_sub_step_3, service_status_sub_step_date_3, service_status_sub_step_4, service_status_sub_step_date_4, service_status_sub_step_5, service_status_sub_step_date_5, service_status_sub_step_6, service_status_sub_step_date_6, service_status_sub_step_7, service_status_sub_step_date_7, service_status_sub_step_8, service_status_sub_step_date_8, service_status_sub_step_9, service_status_sub_step_date_9, service_provider_id, repair_order_number, job_number, claim_number, insurance_assignment_id, service_provider_advisor_id, service_provider_body_tech_id, service_provider_paint_tech_id, service_provider_mech_tech_id, service_provider_trim_tech_id, vehicle_owner_first_name, vehicle_owner_last_name, vehicle_owner_primary_phone, vehicle_owner_secondary_phone, vehicle_owner_primary_email, vehicle_owner_secondary_email, vehicle_owner_email_allowed, vehicle_owner_texting_allowed, carrier_id, vehicle_year, vehicle_make_id, vehicle_model, vehicle_color, vehicle_mileage, vehicle_vin, vehicle_plate_no, vehicle_gone, vehicle_gone_date, vehicle_insurance_id, damage_assessment, vehicle_damage_id, vehicle_service_id, prior_damage_details, total_loss_charges, preliminary_repair_amount, revised_repair_amount, parts_total, parts_alternative, paint_materials, labor_dollars, scheduled_completion_date, revised_completion_date, labor_cycle_time, labor_weekends_holidays, labor_hours_body, labor_hours_paint, labor_hours_mech, labor_hours_trim, labor_hours_frame, labor_sublet, labor_actual_cycle_time, report_card_token, report_card_completed, report_card_a1, report_card_a2, report_card_a3, report_card_a4, report_card_a5, report_card_a6, report_card_a7, report_card_comments, report_card_yes_count, hail_damage, hail_damage_comment, EMS_UNQFILE_ID FROM repair_order WHERE id=$ro_id)";
			$result=mysql_query($sql,$db) or die (mysql_error()."<br> repair_order_deleted SQL= ".$sql);

      $sql="DELETE FROM repair_order WHERE id=$ro_id LIMIT 1";
      $result=mysql_query($sql,$db) or die (mysql_error()."<br>repair_order delete SQL= ".$sql);
      $sql="DELETE FROM repair_order_history WHERE repair_order_id=$ro_id";
      $result=mysql_query($sql,$db) or die (mysql_error()."<br>repair_order_history delete SQL= ".$sql);
      $sql="DELETE FROM repair_order_service_status_sub_step WHERE repair_order_id=$ro_id";
      $result=mysql_query($sql,$db) or die (mysql_error()."<br>repair_order_service_status_sub_step delete SQL= ".$sql);
      $sql="DELETE FROM repair_order_to_do WHERE repair_order_id=$ro_id";
      $result=mysql_query($sql,$db) or die (mysql_error()."<br>repair_order_to_do delete SQL= ".$sql);
      $location=$BASE_HREF."ro_list.html?status=O";
			if ($ro_list_in_id)
				{
					$location.="&in_id=$ro_list_in_id";
				}
      header("Location: $location");
    }
/*----------------------------------------------------------------------------------------*
 * If the form was submitted AND a full edit is needed OR if the calculate promise button *
 * was clicked, edit all of the data on the form.                                         *
 *----------------------------------------------------------------------------------------*/
/*----------------------------------------------------*
 * 2Q 2007 Change: Add promise date preview function. *
 *----------------------------------------------------*/
  if ($preview_promise_date)
    {
      $total_labor_hours=($labor_hours_ri + $labor_hours_body + $labor_hours_paint + $labor_hours_mech + $labor_hours_trim + $labor_hours_frame);
      $cycle_labor_days=ceil($total_labor_hours / $labor_cycle_time);
      $total_days=($cycle_labor_days + $labor_weekends_holidays);
      $clock_start_yyyy=substr($clock_start_date,0,4);
      $clock_start_mm=substr($clock_start_date,5,2);
      $clock_start_dd=substr($clock_start_date,8,2);
      $promise_date=date("Y-m-d",mktime(0,0,0,$clock_start_mm,$clock_start_dd+$total_days,$clock_start_yyyy));
      $show_form=TRUE;
      if ($C1_sub_step=="3")
        {
          if (($original_scheduled_completion_date=="0000-00-00") || (strlen($original_scheduled_completion_date)==0))
            {
              $scheduled_completion_date=$promise_date;
            }
          else
            {
              if ($promise_date_has_been_overridden=="N") $revised_completion_date=$promise_date;
            }
//          $message="<p>Targeted Delivery Date has been recalculated.</p>";
          $preview_promise_date=substr($promise_date,5,2)."-".substr($promise_date,8,2)."-".substr($promise_date,0,4);
          $message="<p>Using the labor details you entered below, the Targeted Delivery Date would be <span class=\"bold\">$preview_promise_date</span>:</p>";
          $message.="<ul>";
          $message.="<li><b>TOTAL LABOR HOURS:</b> $total_labor_hours</li>";
          $message.="<li><b>CYCLE LABOR DAYS:</b> $cycle_labor_days</li>";
          $message.="<li><b>CLOCK START DATE:</b> $clock_start_mm-$clock_start_dd-$clock_start_yyyy</li>";
          $message.="</ul>";
        }
      else
        {
          $preview_promise_date=substr($promise_date,5,2)."-".substr($promise_date,8,2)."-".substr($promise_date,0,4);
          $message="<p>Using the labor details you entered below, the Targeted Delivery Date would be <span class=\"bold\">$preview_promise_date</span>:</p>";
          $message.="<ul>";
          $message.="<li><b>TOTAL LABOR HOURS:</b> $total_labor_hours</li>";
          $message.="<li><b>CYCLE LABOR DAYS:</b> $cycle_labor_days</li>";
          $message.="<li><b>CLOCK START DATE:</b> $clock_start_mm-$clock_start_dd-$clock_start_yyyy</li>";
          $message.="</ul>";
        }
    }
  elseif (($update || $update_too) && ($full_edit==TRUE))
    {
    	$ems=$_POST["ems"];
    	$EMS_UNQFILE_ID=$_POST["EMS_UNQFILE_ID"];
    	$scheduled_completion_date=$_POST["scheduled_completion_date"];

/*------------------------------------------*
 * Calculate the promise date if necessary. *
 *------------------------------------------*/
      if (($C1_sub_step=="3") && ($labor_hours_ri==0) && ($labor_hours_body==0) && ($labor_hours_paint==0) && ($labor_hours_mech==0) && ($labor_hours_trim==0) && ($labor_hours_frame==0))
        {
          if ($promise_date_has_been_overridden=="N")
            {
              $scheduled_completion_date="";
              $revised_completion_date="";
            }
        }
      elseif ($C1_sub_step < 3)
        {
          $scheduled_completion_date="";
          $revised_completion_date="";
        }
      else
        {
          $total_labor_hours=($labor_hours_ri + $labor_hours_body + $labor_hours_paint + $labor_hours_mech + $labor_hours_trim + $labor_hours_frame);
          $cycle_labor_days=ceil($total_labor_hours / $labor_cycle_time);
          $total_days=($cycle_labor_days + $labor_weekends_holidays);
          $clock_start_yyyy=substr($clock_start_date,0,4);
          $clock_start_mm=substr($clock_start_date,5,2);
          $clock_start_dd=substr($clock_start_date,8,2);
          $promise_date=date("Y-m-d",mktime(0,0,0,$clock_start_mm,$clock_start_dd+$total_days,$clock_start_yyyy));
          if (($original_scheduled_completion_date=="0000-00-00") || (strlen($original_scheduled_completion_date)==0))
            {
              $scheduled_completion_date=$promise_date;
            }
          else
            {
              if ($promise_date_has_been_overridden=="N") $revised_completion_date=$promise_date;
            }
        }
/*----------------------------------*
 * Repair Order Number is required. *
 *----------------------------------*/
/*---------------------------------------------------------------------*
 * 3Q 2007 Change: Change & and ? to / to avoid url decoding problems. *
 *---------------------------------------------------------------------*/
      $repair_order_number=str_replace("&", "/", $repair_order_number);
      $repair_order_number=str_replace("?", "/", $repair_order_number);
      if (strlen($repair_order_number)==0)
        {
          $errors[]="Please enter a value for the Repair Order Number.";
          $error_found=TRUE;
        }
/*-----------------------------------------------------------------------*
 * Repair Order Number must not already exist for this Service Provider. *
 * 4Q 2012 - Allow repair order number to be modifiable.                 *
 *-----------------------------------------------------------------------*/
			if (strlen($repair_order_number)>0)
				{
		      if ($ro_id==0)
		      	{
							$sql="SELECT COUNT(*) AS duplicate FROM repair_order WHERE (repair_order_number='$repair_order_number') AND (service_provider_id='$cookie_sp_id')";
						}
					else
						{
							$sql="SELECT COUNT(*) AS duplicate FROM repair_order WHERE (repair_order_number='$repair_order_number') AND (service_provider_id='$cookie_sp_id') AND (id <> $ro_id)";
						}
					$result=mysql_query($sql,$db) or die (mysql_error()."<br>dup ro# check SQL= ".$sql);
					$row=mysql_fetch_array($result);
					$duplicate=$row["duplicate"];
					if ($duplicate>0)
						{
// Added 2013-01-28
$sql="SELECT id as ro_id  FROM repair_order WHERE (repair_order_number='$repair_order_number') AND (service_provider_id='$cookie_sp_id')";
$result=mysql_query($sql,$db) or die (mysql_error()."<br>dup ro# check SQL= ".$sql);
$row=mysql_fetch_array($result);
					$dup_id=$row["ro_id"];

							$errors[]="That Repair Order Number already exists for your Shop. Please enter a different Repair Order Number or <a href='ro_sp.html?ems=$ems&ro_id=$dup_id'>connect</a> to that RO. ";
							$error_found=TRUE;
						}
        }
/*---------------------------------------------------------------------------------------*
 * If an RO is being closed the Ready for Pick-Up/Repairs Completed box must be checked. *
 *                                                                                       *
 * 3Q 2008 Change: If the RO is marked as a Total Loss, it can be closed without the     *
 * Ready for Pick-Up/Repairs Completed box being checked.                                *
 *                                                                                       *
 * 1Q 2012 Change: Make Car Gone Date required when closing an RO.                       *
 *---------------------------------------------------------------------------------------*/
      if (($original_status=="O") && ($status=="C"))
        {
//          if ((strlen($C9)==0) && ($repair_order_service_status_id[9]==0))
          if (!$C9 && !$repair_order_service_status_id[9])
            {
              if ($damage_assessment=="R")
                {
                  $errors[]="Before closing this RO please check the Ready for Pick-Up status box.";
                  $error_found=TRUE;
                }
            }
          if (!$vehicle_gone_date)
          	{
							$errors[]="Before closing this RO please select the Car Gone Date.";
							$error_found=TRUE;
          	}
					if ($remove_car_gone_date)
						{
							$errors[]="When closing an RO you cannot remove the Car Gone Date. Car Gone Date is required when closing an RO.";
							$error_found=TRUE;
						}
        }
/*------------------------------*
 * Service Advisor is required. *
 *------------------------------*/
      if ($service_provider_advisor_id==0)
        {
          $errors[]="Please select a value for the Advisor.";
          $error_found=TRUE;
        }
/*-----------------------------------------------*
 * Service Provider Body Technician is required. *
 *-----------------------------------------------*/
      if ($service_provider_body_tech_id==0)
        {
          $errors[]="Please select someone as the Body Tech.";
          $error_found=TRUE;
        }
/*------------------------------------------------*
 * Service Provider Paint Technician is required. *
 *------------------------------------------------*/
      if ($service_provider_paint_tech_id==0)
        {
          $errors[]="Please select someone as the Paint Tech.";
          $error_found=TRUE;
        }
/*-----------------------------------------------------*
 * Service Provider Mechanical Technician is required. *
 *-----------------------------------------------------*/
      if ($service_provider_mech_tech_id==0)
        {
          $errors[]="Please select someone as the Mechanical Tech.";
          $error_found=TRUE;
        }
/*-----------------------------------------------*
 * Service Provider Trim Technician is required. *
 *-----------------------------------------------*/
      if ($service_provider_trim_tech_id==0)
        {
          $errors[]="Please select someone as the Trim Tech.";
          $error_found=TRUE;
        }
/*--------------------------------*
 * Vehicle Insurance is required. *
 *--------------------------------*/
      if ($vehicle_insurance_id==0)
        {
          $errors[]="Please select an Insurance Company.";
          $error_found=TRUE;
        }
/*-----------------*
 * Reminder edits. *
 *-----------------*/
      if (($new_reminder_type) && (!$new_reminder_date))
        {
          $errors[]="Please select a Reminder Date.";
          $error_found=TRUE;
        }
/*---------------------------------------*
 * Vehicle Owner First Name is required. *
 * 3Q 2009: no longer required.          *
 *---------------------------------------*/
//      if (strlen($vehicle_owner_first_name)==0)
//        {
//          $errors[]="Please enter a value for the Vehicle Owner First Name.";
//          $error_found=TRUE;
//        }
/*--------------------------------------*
 * Vehicle Owner Last Name is required. *
 *--------------------------------------*/
      if (strlen($vehicle_owner_last_name)==0)
        {
          $errors[]="Please enter a value for the Vehicle Owner Last Name.";
          $error_found=TRUE;
        }
/*----------------------------------------------------------------*
 * If entered, Vehicle Owner's Primary Email must be well-formed. *
 *----------------------------------------------------------------*/
      if (strlen($vehicle_owner_primary_email)>0)
        {
          if (!ValidEmail($vehicle_owner_primary_email))
            {
              $errors[]="Vehicle Owner Primary Email is invalid.";
              $error_found=TRUE;
            }
        }
/*------------------------------------------------------------------*
 * If entered, Vehicle Owner's Secondary Email must be well-formed. *
 *------------------------------------------------------------------*/
      if (strlen($vehicle_owner_secondary_email)>0)
        {
          if (!ValidEmail($vehicle_owner_secondary_email))
            {
              $errors[]="Vehicle Owner Secondary Email is invalid.";
              $error_found=TRUE;
            }
        }
/*---------------------------*
 * Vehicle Year is required. *
 *---------------------------*/
      if (strlen($vehicle_year)==0)
        {
          $errors[]="Please select a value for the Vehicle Year.";
          $error_found=TRUE;
        }
/*---------------------------*
 * Vehicle Make is required. *
 *---------------------------*/
      if ($vehicle_make_id==0)
        {
          $errors[]="Please select a value for the Vehicle Make.";
          $error_found=TRUE;
        }
/*----------------------------*
 * Vehicle Model is required. *
 *----------------------------*/
      if (strlen($vehicle_model)==0)
        {
          $errors[]="Please enter a value for the Vehicle Model.";
          $error_found=TRUE;
        }
/*-----------------------------------------------------------------------------------*
 * Repair Authorization Obtained must be selected before any other step is selected. *
 *-----------------------------------------------------------------------------------*/
      if ($C1_sub_step!=3)
        {
          if ($C2_sub_step > 0)
            {
              if ($C2_sub_step <> 1) // Allow Parts pre-order to be selected before authorization.
                {
                  $errors[]="Before selecting a Parts status, please confirm that repair authorization has been obtained.";
                  $error_found=TRUE;
                }
            }
          if ($C3_sub_step > 0)
            {
              $errors[]="Before selecting a Body Repair Process status, please confirm that repair authorization has been obtained.";
              $error_found=TRUE;
            }
          if ($C4_sub_step > 0)
            {
              $errors[]="Before selecting a Paint Process status, please confirm that repair authorization has been obtained.";
              $error_found=TRUE;
            }
          if ($C5_sub_step > 0)
            {
              $errors[]="Before selecting a Mechanical Process status, please confirm that repair authorization has been obtained.";
              $error_found=TRUE;
            }
          if ($C6_sub_step > 0)
            {
              $errors[]="Before selecting a Reassembly Process status, please confirm that repair authorization has been obtained.";
              $error_found=TRUE;
            }
          if ($C7_sub_step > 0)
            {
              $errors[]="Before selecting a Clean-Up Process status, please confirm that repair authorization has been obtained.";
              $error_found=TRUE;
            }
          if ($C8_sub_step > 0)
            {
              $errors[]="Before selecting a QA Process status, please confirm that repair authorization has been obtained.";
              $error_found=TRUE;
            }
          if ($C9=="X")
            {
              $errors[]="Before selecting a Body Repair Process status, please confirm that repair authorization has been obtained.";
              $error_found=TRUE;
            }
        }
/*---------------------------------------------------------------------------*
 * If an RO is being added, check to see an open appointment or an open lead *
 * exists for the combination of Last Name, Vehicle Year, and Vehicle Make). *
 * If the vehicle owner's last name is Enterprise bypass the check for a     *
 * duplicate.                                                                *
 * If this RO is for internal use (vehicle insurance id = 22) bypass the     *
 * check for a duplicate.                                                    *
 * If this RO is for warranty work (vehicle insurance id = 44) bypass the    *
 * check for a duplicate.                                                    *
 * If this RO is for customer pay (vehicle insurance id = 10) bypass the     *
 * check for a duplicate.                                                    *
 *---------------------------------------------------------------------------*/
			$dup_check_needed=TRUE;
			$enterprise_check=stripos($vehicle_owner_last_name, "enterprise");
			if ($enterprise_check === FALSE)
				{
					if ($vehicle_insurance_id==22) // internal use
						{
							$dup_check_needed=FALSE;
						}
					if ($vehicle_insurance_id==44) // warranty work
						{
							$dup_check_needed=FALSE;
						}
					if ($vehicle_insurance_id==10) // customer pay
						{
							$dup_check_needed=FALSE;
						}
				}
			else
				{
					$dup_check_needed=FALSE;
				}
			if ($ro_id)
				{
					$dup_check_needed=FALSE;
				}
			if ($dup_check_needed)
				{
					$decoded_make=DecodeVehicleMake($vehicle_make_id);
					//
					// Is there an active appointment matching this RO?
					//
					$sql_dup_check="SELECT id, claim_number FROM appointment WHERE service_provider_id='$cookie_sp_id' AND status='A' AND vehicle_owner_last_name='$vehicle_owner_last_name' AND vehicle_year='$vehicle_year' AND vehicle_make_id='$vehicle_make_id'";
					$result_dup_check=mysql_query($sql_dup_check, $db) or die (mysql_error()."<br>total loss SQL= ".$sql_dup_check);
					if ($row_dup_check=mysql_fetch_array($result_dup_check))
						{
							if ($row_dup_check[claim_number] && $claim_number)
								{
									if ($row_dup_check[claim_number] == $claim_number)
										{
											$dup_found=TRUE;
											$dup_id=$row_dup_check[id];
											$errors[]="There is an appointment on the calendar for a <b>$vehicle_year $decoded_make</b> under the name <b>$vehicle_owner_last_name</b> for claim number <b>$claim_number</b>. Click <a href=\"calendar/appointment.html?appointment_id=$dup_id\">here</a> to go to the appointment and convert it to an RO.";
				              $error_found=TRUE;
										}
								}
							else
								{
									$dup_found=TRUE;
									$dup_id=$row_dup_check[id];
									$errors[]="There is an appointment on the calendar for a <b>$vehicle_year $decoded_make</b> under the name <b>$vehicle_owner_last_name</b>. Click <a href=\"calendar/appointment.html?appointment_id=$dup_id\">here</a> to go to the appointment and convert it to an RO.";
		              $error_found=TRUE;
								}
						}

					if (!$dup_found)
						{
							//
							// Is there an open call center assignment matching this RO?
							//
							$sql_dup_check="SELECT id, claim_number FROM cc_assignment WHERE service_provider_id='$cookie_sp_id' AND status='O' AND vehicle_owner_last_name='$vehicle_owner_last_name' AND vehicle_year='$vehicle_year' AND vehicle_make_id='$vehicle_make_id'";
							$result_dup_check=mysql_query($sql_dup_check, $db) or die (mysql_error()."<br>total loss SQL= ".$sql_dup_check);
							if ($row_dup_check=mysql_fetch_array($result_dup_check))
								{
									if ($row_dup_check[claim_number] && $claim_number)
										{
											if ($row_dup_check[claim_number] == $claim_number)
												{
													$dup_found=TRUE;
													$dup_id=$row_dup_check[id];
													$errors[]="There is an assignment in the Call Center for a <b>$vehicle_year $decoded_make</b> under the name <b>$vehicle_owner_last_name</b> for claim number <b>$claim_number</b>. Click <a href=\"messages/new_message.html\">here</a> to send an inter-office message to the Call Center.";
													$error_found=TRUE;
												}
										}
									else
										{
											$dup_found=TRUE;
											$dup_id=$row_dup_check[id];
											$errors[]="There is an assignment in the Call Center for a <b>$vehicle_year $decoded_make</b> under the name <b>$vehicle_owner_last_name</b>. Click <a href=\"messages/new_message.html\">here</a> to send an inter-office message to the Call Center.";
											$error_found=TRUE;
										}
								}
						}

					if (!$dup_found)
						{
							//
							// Is there an open lead matching this RO?
							//
							$sql_dup_check="SELECT id FROM lead WHERE service_provider_id='$cookie_sp_id' AND status='O' AND vehicle_owner_last_name='$vehicle_owner_last_name' AND vehicle_year='$vehicle_year' AND vehicle_make_id='$vehicle_make_id'";
							$result_dup_check=mysql_query($sql_dup_check, $db) or die (mysql_error()."<br>total loss SQL= ".$sql_dup_check);
							if ($row_dup_check=mysql_fetch_array($result_dup_check))
								{
									$dup_found=TRUE;
									$dup_id=$row_dup_check[id];
									$errors[]="There is a lead in the Lead Tracker for a <b>$vehicle_year $decoded_make</b> under the name <b>$vehicle_owner_last_name</b>. Click <a href=\"lead_tracker/lead.html?lead_id=$dup_id\">here</a> to go to the lead and convert it to an RO.";
									$error_found=TRUE;
								}
						}

					if (!$dup_found)
						{
							//
							// Is there already an open RO matching this RO?
							//
							$sql_dup_check="SELECT id, claim_number, repair_order_number FROM repair_order WHERE service_provider_id='$cookie_sp_id' AND status='O' AND vehicle_owner_last_name='$vehicle_owner_last_name' AND vehicle_year='$vehicle_year' AND vehicle_make_id='$vehicle_make_id'";
							$result_dup_check=mysql_query($sql_dup_check, $db) or die (mysql_error()."<br>total loss SQL= ".$sql_dup_check);
							if ($row_dup_check=mysql_fetch_array($result_dup_check))
								{
									$dup_found=TRUE;
									$dup_id=$row_dup_check[id];
									$dup_ro=$row_dup_check[repair_order_number];
									//
									// Changed the AND to an OR so that we can have
									// an RO with a claim number and one without.
									//
									// if ($row_dup_check[claim_number] && $claim_number)
									if ($row_dup_check[claim_number] OR $claim_number)
										{
											if ($row_dup_check[claim_number] == $claim_number)
												{
													$dup_found=TRUE;
													$dup_id=$row_dup_check[id];
													$errors[]="There is an existing repair order (<b>RO# $dup_ro</b>) for a <b>$vehicle_year $decoded_make</b> under the name <b>$vehicle_owner_last_name</b> for claim number <b>$claim_number</b>. Click <a href=\"ro_sp.html?ro_id=$dup_id\">here</a> to go to the existing repair order.";
													$error_found=TRUE;
												}
										}
									else
										{
											$dup_found=TRUE;
											$dup_id=$row_dup_check[id];
											$errors[]="There is an existing repair order (<b>RO# $dup_ro</b>) for a <b>$vehicle_year $decoded_make</b> under the name <b>$vehicle_owner_last_name</b>. Click <a href=\"ro_sp.html?ro_id=$dup_id\">here</a> to go to the existing repair order.";
											$error_found=TRUE;
										}
								}
						}
				}
/*-----------------------------------------------------------*
 * If errors are found, format the display back to the user. *
 *-----------------------------------------------------------*/
      if ($error_found==TRUE)
        {
          $message=FormatErrorDisplay($errors);
        }
/*-----------------------------------------------------------------------*
 * If errors are not found, insert a new row or update the existing row. *
 *-----------------------------------------------------------------------*/
      else
        {
          if (($update || $update_too) && ($full_edit==TRUE))
            {
/*--------------------------------------------------------------------------------------------------------*
 * If Repair Authorization Obtained now and it was not when the form was loaded and there are labor hours *
 * entered, calculate the promise date.                                                                   *
 *--------------------------------------------------------------------------------------------------------*/
              if (($labor_hours_body>0) && (($C1_sub_step==3) || ($repair_order_service_status_sub_step[1]==3)))
                {
                  $total_labor_hours=($labor_hours_ri + $labor_hours_body + $labor_hours_paint + $labor_hours_mech + $labor_hours_trim + $labor_hours_frame);
                  $cycle_labor_days=ceil($total_labor_hours / $labor_cycle_time);
                  $total_days=($cycle_labor_days + $labor_weekends_holidays);
                  $clock_start_yyyy=substr($clock_start_date,0,4);
                  $clock_start_mm=substr($clock_start_date,5,2);
                  $clock_start_dd=substr($clock_start_date,8,2);
                  $promise_date=date("Y-m-d",mktime(0,0,0,$clock_start_mm,$clock_start_dd+$total_days,$clock_start_yyyy));
                  if ($original_scheduled_completion_date=="0000-00-00")
                    {
                      $scheduled_completion_date=$promise_date;
                    }
                  else
                    {
                      if ($promise_date_has_been_overridden=="N") $revised_completion_date=$promise_date;
                    }
                }
              $service_status_sql_clause="";
              $service_status_sub_step_sql_clause="";
/*----------------------------------------------------------------------------------*
 * If Repair authorization obtained now, but it wasn't when the form was loaded we  *
 * need to save the date as the starting date of the ro for legacy functionality to *
 * work.                                                                            *
 *----------------------------------------------------------------------------------*/
              if (($C1_sub_step==3) && ($repair_order_service_status_sub_step[1]!=3))
                {
                  $service_status_1="X";
                  $service_status_date_1=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_1='$service_status_1', service_status_date_1='$service_status_date_1'";
                }
              if ($C1_sub_step != $repair_order_service_status_sub_step[1])
                {
                  $service_status_sub_step_1=$C1_sub_step;
                  $service_status_sub_step_date_1=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_1='$service_status_1', service_status_date_1='$service_status_date_1'";
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_1='$service_status_sub_step_1', service_status_sub_step_date_1='$service_status_sub_step_date_1'";
                }
              if ($C2_sub_step != $repair_order_service_status_sub_step[2])
                {
                  $service_status_2="X";
                  $service_status_date_2=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_2='$service_status_2', service_status_date_2='$service_status_date_2'";

                  $service_status_sub_step_2=$C2_sub_step;
                  $service_status_sub_step_date_2=date("Y-m-d");
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_2='$service_status_sub_step_2', service_status_sub_step_date_2='$service_status_sub_step_date_2'";
                }
              if ($C3_sub_step != $repair_order_service_status_sub_step[3])
                {
                  $service_status_3="X";
                  $service_status_date_3=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_3='$service_status_3', service_status_date_3='$service_status_date_3'";

                  $service_status_sub_step_3=$C3_sub_step;
                  $service_status_sub_step_date_3=date("Y-m-d");
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_3='$service_status_sub_step_3', service_status_sub_step_date_3='$service_status_sub_step_date_3'";
                }
              if ($C4_sub_step != $repair_order_service_status_sub_step[4])
                {
                  $service_status_4="X";
                  $service_status_date_4=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_4='$service_status_4', service_status_date_4='$service_status_date_4'";

                  $service_status_sub_step_4=$C4_sub_step;
                  $service_status_sub_step_date_4=date("Y-m-d");
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_4='$service_status_sub_step_4', service_status_sub_step_date_4='$service_status_sub_step_date_4'";
                }
              if ($C5_sub_step != $repair_order_service_status_sub_step[5])
                {
                  $service_status_5="X";
                  $service_status_date_5=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_5='$service_status_5', service_status_date_5='$service_status_date_5'";

                  $service_status_sub_step_5=$C5_sub_step;
                  $service_status_sub_step_date_5=date("Y-m-d");
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_5='$service_status_sub_step_5', service_status_sub_step_date_5='$service_status_sub_step_date_5'";
                }
              if ($C6_sub_step != $repair_order_service_status_sub_step[6])
                {
                  $service_status_6="X";
                  $service_status_date_6=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_6='$service_status_6', service_status_date_6='$service_status_date_6'";

                  $service_status_sub_step_6=$C6_sub_step;
                  $service_status_sub_step_date_6=date("Y-m-d");
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_6='$service_status_sub_step_6', service_status_sub_step_date_6='$service_status_sub_step_date_6'";
                }
              if ($C7_sub_step != $repair_order_service_status_sub_step[7])
                {
                  $service_status_7="X";
                  $service_status_date_7=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_7='$service_status_7', service_status_date_7='$service_status_date_7'";

                  $service_status_sub_step_7=$C7_sub_step;
                  $service_status_sub_step_date_7=date("Y-m-d");
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_7='$service_status_sub_step_7', service_status_sub_step_date_7='$service_status_sub_step_date_7'";
                }
              if ($C8_sub_step != $repair_order_service_status_sub_step[8])
                {
                  $service_status_8="X";
                  $service_status_date_8=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_8='$service_status_8', service_status_date_8='$service_status_date_8'";

                  $service_status_sub_step_8=$C8_sub_step;
                  $service_status_sub_step_date_8=date("Y-m-d");
                  $service_status_sub_step_sql_clause.=", service_status_sub_step_8='$service_status_sub_step_8', service_status_sub_step_date_8='$service_status_sub_step_date_8'";
                }
              if (($C9=="X") && ($repair_order_service_status_id[9]==0))
                {
                  $service_status_9="X";
                  $service_status_date_9=date("Y-m-d");
                  $service_status_sql_clause.=", service_status_9='$service_status_9', service_status_date_9='$service_status_date_9'";
                }
/*----------------------------------------------------------------------------------------------*
 * If the Promise Date is being overriden ($override_date), update the revised_completion_date. *
 *----------------------------------------------------------------------------------------------*/
              if (strlen($override_date>0))
                {
                  $revised_completion_date=substr($override_date,6,4)."-".substr($override_date,0,2)."-".substr($override_date,3,2);
                }
/*----------------------------------------------------------------------------------------------*
 * Determine overall service_status. This field was added so that the RO list could be sorted   *
 * by this field. It represents the current sub step status that an RO is in.                   *
 *----------------------------------------------------------------------------------------------*/
              if ($original_service_status=="9.0")
                {
                  $service_status="9.0";
                }
              else
                {
                  if ($C9=="X") $service_status="9.0";
                  elseif ($C8_sub_step>0) $service_status="8.".$C8_sub_step;
                  elseif ($C7_sub_step>0) $service_status="7.".$C7_sub_step;
                  elseif ($C6_sub_step>0) $service_status="6.".$C6_sub_step;
                  elseif ($C5_sub_step>0) $service_status="5.".$C5_sub_step;
                  elseif ($C4_sub_step>0) $service_status="4.".$C4_sub_step;
                  elseif ($C3_sub_step>0) $service_status="3.".$C3_sub_step;
                  elseif ($C2_sub_step>0) $service_status="2.".$C2_sub_step;
                  elseif ($C1_sub_step>0) $service_status="1.".$C1_sub_step;
                  else $service_status="0.0";
                }
              if ($damage_assessment=="TL")
                {
                  $preliminary_repair_amount=0;
                  $revised_repair_amount=0;
                  $labor_dollars=0;
                  $pdr_dollars=0;
                  $ri_dollars=0;
                  $labor_hours_ri=0;
                  $labor_hours_body=0;
                  $labor_hours_paint=0;
                  $labor_hours_mech=0;
                  $labor_hours_trim=0;
                  $labor_hours_frame=0;
                  $labor_sublet=0;
                }
              if ($damage_assessment=="R")
                {
                  $total_loss_charges=0;
                }
              $date_added=substr($date_added,6,4)."-".substr($date_added,0,2)."-".substr($date_added,3,2);
							$date_arrived=substr($date_arrived,6,4)."-".substr($date_arrived,0,2)."-".substr($date_arrived,3,2);
//							if ($ems)
//								{
//									echo "This function is still being developed.";
//									exit();
//								}

              $ppg_diff=$paint_materials - $ppg_total_cost;

              if ($ro_id==0)
                {
									$vehicle_owner_email_allowed="Y";
									$vehicle_owner_texting_allowed="Y";
									$send_email_status='Y';
                  $sql="INSERT INTO repair_order (date_added, date_arrived, date_updated, last_update_user_id, status, send_email_status, hot_file, hot_file_comment, hail_damage, hail_damage_comment, cycle_time_vehicle, cycle_time_vehicle_comment, fast_track, fast_track_comment, eom, eom_comment, multi_point_inspection, multi_point_inspection_comment, bumper_only_job, bumper_only_job_comment, rework, rework_comment, service_status, service_provider_id, repair_order_number, job_number, claim_number, service_provider_advisor_id, service_provider_body_tech_id, service_provider_paint_tech_id, service_provider_mech_tech_id, service_provider_trim_tech_id, vehicle_owner_first_name, vehicle_owner_last_name, vehicle_owner_primary_phone, vehicle_owner_secondary_phone, vehicle_owner_primary_email, vehicle_owner_secondary_email, vehicle_owner_email_allowed, vehicle_owner_texting_allowed, carrier_id, vehicle_year, vehicle_make_id, vehicle_model, vehicle_color, vehicle_mileage, vehicle_vin, vehicle_plate_no, vehicle_insurance_id, damage_assessment, recall, vehicle_damage_id, vehicle_service_id, prior_damage_details, total_loss_charges, preliminary_repair_amount, revised_repair_amount, parts_total, parts_alternative, paint_materials, ppg_diff, labor_dollars, pdr_dollars, ri_dollars, scheduled_completion_date, revised_completion_date, labor_cycle_time, labor_weekends_holidays, labor_hours_ri, labor_hours_body, labor_hours_paint, labor_hours_mech, labor_hours_trim, labor_hours_frame, labor_sublet, service_status_1, service_status_date_1, service_status_2, service_status_date_2, service_status_3, service_status_date_3, service_status_4, service_status_date_4, service_status_5, service_status_date_5, service_status_6, service_status_date_6, service_status_7, service_status_date_7, service_status_8, service_status_date_8, service_status_9, service_status_date_9, service_status_sub_step_1, service_status_sub_step_date_1, service_status_sub_step_2, service_status_sub_step_date_2, service_status_sub_step_3, service_status_sub_step_date_3, service_status_sub_step_4, service_status_sub_step_date_4, service_status_sub_step_5, service_status_sub_step_date_5, service_status_sub_step_6, service_status_sub_step_date_6, service_status_sub_step_7, service_status_sub_step_date_7, service_status_sub_step_8, service_status_sub_step_date_8, service_status_sub_step_9, service_status_sub_step_date_9, EMS_UNQFILE_ID) ";
                  $sql.="VALUES ('$date_added', '$date_arrived', NOW(), '$lookup_user_id', 'O', '$send_email_status', '$hot_file', '$hot_file_comment', '$hail_damage', '$hail_damage_comment', '$cycle_time_vehicle', '$cycle_time_vehicle_comment', '$fast_track', '$fast_track_comment', '$eom', '$eom_comment', '$multi_point_inspection', '$multi_point_inspection_comment', '$bumper_only_job', '$bumper_only_job_comment', '$rework', '$rework_comment', '$service_status', '$cookie_sp_id', '$repair_order_number', '$job_number', '$claim_number', '$service_provider_advisor_id', '$service_provider_body_tech_id', '$service_provider_paint_tech_id', '$service_provider_mech_tech_id', '$service_provider_trim_tech_id', '$vehicle_owner_first_name', '$vehicle_owner_last_name', '$vehicle_owner_primary_phone', '$vehicle_owner_secondary_phone', '$vehicle_owner_primary_email', '$vehicle_owner_secondary_email', '$vehicle_owner_email_allowed', '$vehicle_owner_texting_allowed', '$carrier_id', '$vehicle_year', '$vehicle_make_id', '$vehicle_model', '$vehicle_color', '$vehicle_mileage', '$vehicle_vin', '$vehicle_plate_no', '$vehicle_insurance_id', '$damage_assessment', '$recall', '$vehicle_damage_id', '$vehicle_service_id', '$prior_damage_details', '$total_loss_charges', '$preliminary_repair_amount', '$revised_repair_amount', '$parts_total', '$parts_alternative', '$paint_materials', '$ppg_diff', '$labor_dollars', '$pdr_dollars', '$ri_dollars', '$scheduled_completion_date', '$revised_completion_date', '$labor_cycle_time', '$labor_weekends_holidays', '$labor_hours_ri', '$labor_hours_body', '$labor_hours_paint', '$labor_hours_mech', '$labor_hours_trim', '$labour_hours_frame', '$labor_sublet', '$service_status_1', '$service_status_date_1', '$service_status_2', '$service_status_date_2', '$service_status_3', '$service_status_date_3', '$service_status_4', '$service_status_date_4', '$service_status_5', '$service_status_date_5', '$service_status_6', '$service_status_date_6', '$service_status_7', '$service_status_date_7', '$service_status_8', '$service_status_date_8', '$service_status_9', '$service_status_date_9', '$service_status_sub_step_1', '$service_status_sub_step_date_1', '$service_status_sub_step_2', '$service_status_sub_step_date_2', '$service_status_sub_step_3', '$service_status_sub_step_date_3', '$service_status_sub_step_4', '$service_status_sub_step_date_4', '$service_status_sub_step_5', '$service_status_sub_step_date_5', '$service_status_sub_step_6', '$service_status_sub_step_date_6', '$service_status_sub_step_7', '$service_status_sub_step_date_7', '$service_status_sub_step_8', '$service_status_sub_step_date_8', '$service_status_sub_step_9', '$service_status_sub_step_date_9', '$ems')";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>repair_order insert SQL= ".$sql);
                  $ro_id=mysql_insert_id();

									if ($ems)
										{
											include "includes/ems_file_types.html";
											foreach ($ems_file_extensions as $file_ext => $file_description)
												{
													$ems_file=$ems.".".$file_ext;
													$table="_pathways_".strtolower($file_ext);
													if ($file_ext=="LIN")
														{

												$ems_sql="UPDATE $table SET mrt_status='C', repair_order_id=$ro_id WHERE ems_file='$ems_file' and mrt_status='O' and service_provider_id = '$cookie_sp_id'";
														}
													else
														{
															$ems_sql="UPDATE $table SET mrt_status='C' WHERE ems_file='$ems_file' and mrt_status = 'O' and service_provider_id = '$cookie_sp_id'";
														}
													$ems_result=mysql_query($ems_sql,$db) or die (mysql_error()."<br>update pathways SQL= ".$ems_sql);
												}
										}
                }
              else
                {
                  if ($vehicle_gone_date)
                    {
                    	if ($remove_car_gone_date)
                    		{
		                      $vehicle_gone="";
		                      $vehicle_gone_date="";
                  				$sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'A', 'Car Gone Date removed')";
                  				$result=mysql_query($sql,$db) or die (mysql_error()."<br>advisor note insert SQL= ".$sql);
                    		}
                    	else
                    		{
													if ($vehicle_gone_date=="0000-00-00")
														{
														}
													else
														{
															if ($original_vehicle_gone_date=="0000-00-00" OR $original_vehicle_gone_date=="")
																{
				                  				$sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'A', 'Car Gone Date stamped - $vehicle_gone_date')";
				                  				$result=mysql_query($sql,$db) or die (mysql_error()."<br>advisor note insert SQL= ".$sql);
																}
                      				$vehicle_gone="X";
                      				$vehicle_gone_date=substr($vehicle_gone_date,6,4)."-".substr($vehicle_gone_date,0,2)."-".substr($vehicle_gone_date,3,2);
                    				}
                    		}
                    }

                  $sql="UPDATE repair_order SET date_added='$date_added', date_arrived='$date_arrived', date_updated=NOW(), last_update_user_id='$lookup_user_id', status='$status', hot_file='$hot_file', hot_file_comment='$hot_file_comment', hail_damage='$hail_damage', hail_damage_comment='$hail_damage_comment', cycle_time_vehicle='$cycle_time_vehicle', cycle_time_vehicle_comment='$cycle_time_vehicle_comment', fast_track='$fast_track', fast_track_comment='$fast_track_comment', eom='$eom', eom_comment='$eom_current', multi_point_inspection='$multi_point_inspection', multi_point_inspection_comment='$multi_point_inspection_comment', bumper_only_job='$bumper_only_job', bumper_only_job_comment='$bumper_only_job_comment', rework='$rework', rework_comment='$rework_comment', repair_order_number='$repair_order_number', service_status='$service_status', job_number='$job_number', claim_number='$claim_number', service_provider_advisor_id='$service_provider_advisor_id', service_provider_body_tech_id='$service_provider_body_tech_id', service_provider_paint_tech_id='$service_provider_paint_tech_id', service_provider_mech_tech_id='$service_provider_mech_tech_id', service_provider_trim_tech_id='$service_provider_trim_tech_id', vehicle_owner_first_name='$vehicle_owner_first_name', vehicle_owner_last_name='$vehicle_owner_last_name', vehicle_owner_primary_phone='$vehicle_owner_primary_phone', vehicle_owner_secondary_phone='$vehicle_owner_secondary_phone', vehicle_owner_primary_email='$vehicle_owner_primary_email', vehicle_owner_secondary_email='$vehicle_owner_secondary_email', carrier_id='$carrier_id', vehicle_year='$vehicle_year', vehicle_make_id='$vehicle_make_id', vehicle_model='$vehicle_model', vehicle_color='$vehicle_color', vehicle_mileage='$vehicle_mileage', vehicle_vin='$vehicle_vin', vehicle_plate_no='$vehicle_plate_no', vehicle_gone='$vehicle_gone', vehicle_gone_date='$vehicle_gone_date', vehicle_insurance_id='$vehicle_insurance_id', damage_assessment='$damage_assessment', recall='$recall', vehicle_damage_id='$vehicle_damage_id', vehicle_service_id='$vehicle_service_id', prior_damage_details='$prior_damage_details', total_loss_charges='$total_loss_charges', preliminary_repair_amount='$preliminary_repair_amount', revised_repair_amount='$revised_repair_amount', parts_total='$parts_total', parts_alternative='$parts_alternative', paint_materials='$paint_materials', ppg_diff='$ppg_diff', labor_dollars='$labor_dollars', pdr_dollars='$pdr_dollars', ri_dollars='$ri_dollars', scheduled_completion_date='$scheduled_completion_date', revised_completion_date='$revised_completion_date', labor_cycle_time='$labor_cycle_time', labor_weekends_holidays='$labor_weekends_holidays', labor_hours_ri='$labor_hours_ri', labor_hours_body='$labor_hours_body', labor_hours_paint='$labor_hours_paint', labor_hours_mech='$labor_hours_mech', labor_hours_trim='$labor_hours_trim', labor_hours_frame='$labor_hours_frame', labor_sublet='$labor_sublet'";

                  if ($service_status<>$original_service_status)
                  	{
											$sql.=", send_email_status='Y'";
										}

                  $sql.=$service_status_sql_clause.$service_status_sub_step_sql_clause." WHERE id='$ro_id' and service_provider_id = '$cookie_sp_id' LIMIT 1";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>update ro SQL= ".$sql);


/*-----------------------------------------------------------------------------------------------*
 * If the Repair Order Number Changed, update the repair_order_number field in the MESSAGE table *
 * to the new value.                                                                             *
 *-----------------------------------------------------------------------------------------------*/
									if ($repair_order_number <> $original_repair_order_number)
										{
											$sql="UPDATE message SET repair_order_number = '$repair_order_number' WHERE repair_order_number = '$original_repair_order_number'";
											$result=mysql_query($sql,$db) or die (mysql_error()."<br>6a SQL= ".$sql);

											$ro_changed_note="RO Number was changed from <b>" . $original_repair_order_number . "</b> to <b>" . $repair_order_number ."</b>";
		                  $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'M', '$ro_changed_note')";
		                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>advisor note insert SQL= ".$sql);
										}

									// echo "<p>SQL=$sql</p>";
									// exit();
									if ($ems)
										{
											$sql="UPDATE repair_order SET EMS_UNQFILE_ID='$ems' WHERE id='$ro_id' and service_provider_id = '$cookie_sp_id' LIMIT 1";
											$result=mysql_query($sql,$db) or die (mysql_error()."<br>update ro w/ emsfile SQL= ".$sql);

											include "includes/ems_file_types.html";
											foreach ($ems_file_extensions as $file_ext => $file_description)
												{
													$ems_file=$ems.".".$file_ext;
													$table="_pathways_".strtolower($file_ext);
													if ($file_ext=="LIN")
														{
if ($cookie_sp_id == 176)
{

$validate_status =  "select count(*)  from _pathways_lin l where l.mrt_status = 'O'   and l.ems_file = '$ems_file'   and l.service_provider_id = '$cookie_sp_id'";
			$test_result=mysql_query($validate_status,$db) or die (mysql_error()."<br> part status validation SQL= ".$validate_status);
                        $test_field = mysql_result($test_result, 0);


       /*   mail("To:TracyM@ssysinc.com", "count (sp=$cookie_sp_id, $ems, ro=$ro_id) = $test_field", "test status $test_field",  "From: tracyM@ssysinc.com\r\n");
        */
} /* if service provider = Allen Samuels - Tyler (176) */

                       $part_status_update=<<<SQL
update _pathways_lin l
	inner join _pathways_lin ol
           on ol.ems_file = l.ems_file
          and ol.service_provider_id = l.service_provider_id
set l.mrt_part_status = ol.mrt_part_status,
    l.mrt_part_status_date = ol.mrt_part_status_date
WHERE l.mrt_status = 'O'
  and l.ems_file = '$ems_file'
  and l.service_provider_id = '$cookie_sp_id'
  AND ol.mrt_part_status != 'N'
   and ol.part_type = l.part_type
   and ol.mrt_status = 'C'
   and ol.mod_lbr_ty = l.mod_lbr_ty
   and ol.lbr_op = l.lbr_op
   and ol.line_desc = l.line_desc
SQL;
			$ems_result=mysql_query($part_status_update,$db) or die (mysql_error()."<br> part status update SQL= ".$part_status_update);

        $test_field = mysql_affected_rows ();

        /*
         mail("To:TracyM@ssysinc.com", "rows_affected (sp=$cookie_sp_id, $ems, ro=$ro_id) = $test_field", "test status $test_field",  "From: tracyM@ssysinc.com\r\n");
         */

                        $dup_prevent=<<<SQL
update $table
set mrt_status='P'
where mrt_status='C'
  and ems_file = '$ems_file'
  and service_provider_id = '$cookie_sp_id'
SQL;
			$ems_result=mysql_query($dup_prevent,$db) or die (mysql_error()."<br> dup_prevent SQL= ".$dup_prevent);

															$ems_sql="UPDATE $table SET mrt_status='C', repair_order_id=$ro_id WHERE ems_file='$ems_file' and mrt_status='O' and service_provider_id = '$cookie_sp_id'";

														}
													else
														{
															$ems_sql="UPDATE $table SET mrt_status='C' WHERE ems_file='$ems_file' and mrt_status = 'O' and service_provider_id = '$cookie_sp_id'";
														}
													$ems_result=mysql_query($ems_sql,$db) or die (mysql_error()."<br>update ems2 SQL= ".$ems_sql);

												}
										}
                }
/*------------------------------*
 * Add a reminder if necessary. *
 *------------------------------*/
              if ($new_reminder_type)
                {
                  $reminder_date=substr($new_reminder_date,6,4)."-".substr($new_reminder_date,0,2)."-".substr($new_reminder_date,3,2);
                  $sql="INSERT INTO reminder (repair_order_id, reminder_date, reminder_type) VALUES ('$ro_id', '$reminder_date', '$new_reminder_type')";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>insert reminder SQL= ".$sql);
                }
/*--------------------------------*
 * Delete reminders if necessary. *
 *--------------------------------*/
               for ($i=0;$i<count($reminder_del);$i++)
                 {
                   if ($reminder_del[$i]=="X")
                     {
                       $sql="DELETE FROM reminder WHERE id='$reminder_id[$i]' LIMIT 1";
                       $result=mysql_query($sql,$db) or die (mysql_error()."<br>delete reminder SQL= ".$sql);
                     }
                 }
/*-------------------------------------------------*
 * If the repair authorization is obtained, add a  *
 * row to the repair_order_service_status table.   *
 *-------------------------------------------------*/
              if (($C1_sub_step==3) && ($repair_order_service_status_sub_step[1]!=3))
                {
                  $sql="INSERT INTO repair_order_service_status (date_added, last_update_user_id, repair_order_id, service_status) VALUES (NOW(), '$lookup_user_id', $ro_id, '1')";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>ro service status insert SQL= ".$sql);
                }
/*--------------------------------------------------------------------------------*
 * If the RO is being closed, add a row to the repair_order_service_status table. *
 *--------------------------------------------------------------------------------*/
              if (($C9=="X") && ($repair_order_service_status_id[9]==0))
                {
                  $sql="INSERT INTO repair_order_service_status (date_added, last_update_user_id, repair_order_id, service_status) VALUES (NOW(), '$lookup_update_user_id', $ro_id, '9')";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>ro service status insert 2 SQL= ".$sql);
                  if (!$end_date) $end_date=date("Y-m-d H:i:s");
                }
              $from="$lookup_company_name (MyRepairTracker.com) <info@myrepairtracker.com>";
              $spa_sql="SELECT * FROM user WHERE user_id='$service_provider_advisor_id' LIMIT 1";
              $spa_result=mysql_query($spa_sql,$db) or die (mysql_error()."<br>user lookup SQL= ".$spa_sql);
              if ($spa_row=mysql_fetch_array($spa_result))
                {
                  $spa_first_name=$spa_row["user_first_name"];
                  $spa_last_name=$spa_row["user_last_name"];
                  $spa_name=$spa_row["user_first_name"]." ".$spa_row["user_last_name"];
                  $spa_email=$spa_row["user_email"];
                  $from="$lookup_company_name ($spa_name) <$spa_email>";
                }
/*--------------------------------------------*
 * Add new service advisor note if necessary. *
 *--------------------------------------------*/
              if ($note)
                {
                  $sql_note=mysql_real_escape_string($note);
                  $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'M', '$sql_note')";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>advisor note insert SQL= ".$sql);
                }
/*---------------------------------------*
 * Send total loss message if necessary. *
 *---------------------------------------*/
              if (($damage_assessment=="TL") && ($damage_assessment!=$original_damage_assessment))
                {
                  if (strlen($lookup_total_loss_contact_email)>0)
                    {
                      if ($vehicle_make_id>0)
                        {
                          $sql_make_lookup="SELECT * FROM vehicle_make WHERE id=$vehicle_make_id LIMIT 1";
                          $result_make_lookup=mysql_query($sql_make_lookup,$db) or die (mysql_error()."<br>total loss SQL= ".$sql_make_lookup);
                          if ($row_make_lookup=mysql_fetch_array($result_make_lookup))
                            {
                              $vehicle_make=$row_make_lookup["make"];
                            }
                          else
                            {
                              $vehicle_make="N/A";
                            }
                        }
                      else
                        {
                          $vehicle_make="N/A";
                        }
                      $to=$lookup_total_loss_contact_email;
                      $report_card_token=keyblock(10,1);
                      $body="******************************\n";
                      $body.="A Note from My Repair Tracker\n";
                      $body.="*****************************\n";
                      $body.="\n";
                      $body.="A Repair Order has been marked as a Total Loss. This is a qualified lead. The customer information is below. For more details about this Repair Order access My Repair Tracker at $reference_url.\n";
                      $body.="\n";
                      $body.="Repair Order Number: $repair_order_number\n";
                      $body.="Vehicle: $vehicle_year $vehicle_make $vehicle_model\n";
                      $body.="Vehicle Owner Name: $vehicle_owner_first_name $vehicle_owner_last_name\n";
                      $body.="Vehicle Owner Primary Phone: $vehicle_owner_primary_phone \n";
                      $body.="Vehicle Owner Cellular Phone: $vehicle_owner_secondary_phone \n";
                      $body.="Vehicle Owner Email: $vehicle_owner_primary_email";
                      if ($vehicle_owner_secondary_email) $body.=" -OR- $vehicle_owner_secondary_email";
                      $body.="\n";
					  					$body.="NOTE: This is an automated email from MyRepairTracker.com. Please do not reply directly to this system-generated email.\n";
                      // $subject="My Repair Tracker - Qualified Lead from Total Loss";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";
                      mail($to, $subject, $body, $headers);
                      $sql_note="TOTAL LOSS NOTICE SENT: $to";
                      $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'O', '$sql_note')";
                      $result=mysql_query($sql,$db) or die (mysql_error()."<br>email sent SQL= ".$sql);

											$log_subject=addslashes($subject);
											$log_body=addslashes($body);
											$log_to=addslashes($to);
											$log_headers=addslashes($headers);
                    	$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
                    	$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log SQL= ".$email_log_sql);
                    }
                }

              $new_service_status="";
              $send_email_and_text=FALSE;

/*--------------------------*
 * 1. Repair Authorization. *
 *--------------------------*/
              if (($C1_sub_step > 0) && ($C1_sub_step!=$repair_order_service_status_sub_step[1]))
                {
                  $note_text="";
                  if ($C1_sub_step==1)
                    {
                      $note_text="Repair Authorization --> Awaiting insurance authorization";
                      $new_service_status="1.1";
                    }
				  				if ($C1_sub_step==2)
				  				  {
				  				    $note_text="Repair Authorization --> Awaiting customer authorization";
				  				    $new_service_status="1.2";
				  				  }
				  				if ($C1_sub_step==3)
				  				  {
				  				    $note_text="Repair Authorization --> Repair authorization obtained";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                          	{
                            	if ($carrier_id)
                            		{
                                 	$note_text.=" (Customer has been notified via text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                              	}
                        		}
                        }
                      $new_service_status="1.3";
                      $send_email_and_text=TRUE;
				  			  	}
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 2. Parts.                *
 *--------------------------*/
              if (($C2_sub_step > 0) && ($C2_sub_step!=$repair_order_service_status_sub_step[2]))
                {
                  $note_text="";
                  if ($C2_sub_step==1)
                    {
                      $note_text="Parts --> Parts pre-order";
                      $new_service_status="2.1";
                    }
								  if ($C2_sub_step==2)
								    {
								      $note_text="Parts --> Parts hold";
								      $new_service_status="2.2";
								    }
								  if ($C2_sub_step==3)
								    {
								      $note_text="Parts --> Parts ordered";
								      $new_service_status="2.3";
								    }
								  if ($C2_sub_step==4)
								    {
								      $note_text="Parts --> Parts received";
								      $new_service_status="2.4";
								    }
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 3. Body Repair Process.  *
 *--------------------------*/
              if (($C3_sub_step > 0) && ($C3_sub_step!=$repair_order_service_status_sub_step[3]))
                {
                  $note_text="";
                  if ($C3_sub_step==1)
                    {
                      $note_text="Body Repair Process --> Disassembly";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                          	{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
                        		}
                        }
                      $new_service_status="3.1";
                      $send_email_and_text=TRUE;
                    }
				  				if ($C3_sub_step==2)
				  				  {
				  				    $note_text="Body Repair Process --> Estimate review";
				  				    $new_service_status="3.2";
				  				  }
				  				if ($C3_sub_step==3)
				    				{
				    				  $note_text="Body Repair Process --> Supplement hold";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}
                        }
                      $new_service_status="3.3";
                      $send_email_and_text=TRUE;
				    				}
				  				if ($C3_sub_step==4)
				  				  {
				  				    $note_text="Body Repair Process --> Parts hold";
				  				    $new_service_status="3.4";
				  				  }
				  				if ($C3_sub_step==5)
				  				  {
				  				    $note_text="Body Repair Process --> Awaiting metal";
				  				    $new_service_status="3.5";
				  				  }
				  				if ($C3_sub_step==6)
				  				  {
				  				    $note_text="Body Repair Process --> Working metal";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}
                        }
                      $new_service_status="3.6";
                      $send_email_and_text=TRUE;
				  				  }
				  				if ($C3_sub_step==7)
				  				  {
				  				    $note_text="Body Repair Process --> Body repair complete";
				  				    $new_service_status="3.7";
				  				  }
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 4. Paint Process.        *
 *--------------------------*/
              if (($C4_sub_step > 0) && ($C4_sub_step!=$repair_order_service_status_sub_step[4]))
                {
                  $note_text="";
                  if ($C4_sub_step==1)
                    {
                      $note_text="Paint Process --> Supplement hold";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}
                        }
                      $new_service_status="4.1";
                      $send_email_and_text=TRUE;
                    }
								  if ($C4_sub_step==2)
								    {
								      $note_text="Paint Process --> Parts hold";
								      $new_service_status="4.2";
								    }
								  if ($C4_sub_step==3)
								    {
								      $note_text="Paint Process --> Cut-In";
								      $new_service_status="4.3";
								    }
								  if ($C4_sub_step==4)
								    {
								      $note_text="Paint Process --> Working prep";
								      $new_service_status="4.4";
								    }
								  if ($C4_sub_step==5)
								    {
								      $note_text="Paint Process --> Awaiting paint";
								      $new_service_status="4.5";
								    }
								  if ($C4_sub_step==6)
								    {
								      $note_text="Paint Process --> Working paint";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}
                        }
                      $new_service_status="4.6";
                      $send_email_and_text=TRUE;
								    }
								  if ($C4_sub_step==7)
								    {
								      $note_text="Paint Process --> Awaiting buff";
								      $new_service_status="4.7";
								    }
								  if ($C4_sub_step==8)
								    {
								      $note_text="Paint Process --> Working buff";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}
                        }
                      $new_service_status="4.8";
                      $send_email_and_text=TRUE;
								    }
								  if ($C4_sub_step==9)
								    {
								      $note_text="Paint Process --> Paint complete";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}
                        }
								      $new_service_status="4.9";
		                  $send_email_and_text=TRUE;
								    }
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 5. Mechanical Process.   *
 *--------------------------*/
              if (($C5_sub_step > 0) && ($C5_sub_step!=$repair_order_service_status_sub_step[5]))
                {
                  $note_text="";
                  if ($C5_sub_step==1)
                    {
                      $note_text="Mechanical Process --> Supplement hold";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}
                        }
                      $new_service_status="5.1";
                      $send_email_and_text=TRUE;
                    }
								  if ($C5_sub_step==2)
								    {
								      $note_text="Mechanical Process --> Parts hold";
								      $new_service_status="5.2";
								    }
								  if ($C5_sub_step==3)
								    {
								      $note_text="Mechanical Process --> Awaiting mechanical";
								      $new_service_status="5.3";
								    }
								  if ($C5_sub_step==4)
								    {
								      $note_text="Mechanical Process --> Working mechanical";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                        }
		                  $send_email_and_text=TRUE;
								      $new_service_status="5.4";
								    }
								  if ($C5_sub_step==5)
								    {
								      $note_text="Mechanical Process --> Awaiting suspension";
								      $new_service_status="5.5";
								    }
								  if ($C5_sub_step==6)
								    {
								      $note_text="Mechanical Process --> Working suspension";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                        }
                      $send_email_and_text=TRUE;
								      $new_service_status="5.6";
								    }
								  if ($C5_sub_step==7)
								    {
								      $note_text="Mechanical Process --> Mechanical complete";
								      $new_service_status="5.7";
								    }
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 6. Reassembly Process.   *
 *--------------------------*/
              if (($C6_sub_step > 0) && ($C6_sub_step!=$repair_order_service_status_sub_step[6]))
                {
                  $note_text="";
                  if ($C6_sub_step==1)
                    {
                      $note_text="Reassembly Process --> Supplement hold";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                        }
                      $new_service_status="6.1";
                      $send_email_and_text=TRUE;
                    }
							  	if ($C6_sub_step==2)
								    {
								      $note_text="Reassembly Process --> Parts hold";
								      $new_service_status="6.2";
								    }
								  if ($C6_sub_step==3)
								    {
								      $note_text="Reassembly Process --> Awaiting trim";
								      $new_service_status="6.3";
								    }
								  if ($C6_sub_step==4)
								    {
								      $note_text="Reassembly Process --> Working trim";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                        }
		                  $send_email_and_text=TRUE;
								      $new_service_status="6.4";
								    }
								  if ($C6_sub_step==5)
								    {
								      $note_text="Reassembly Process --> Reassembly complete";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                        }
								      $new_service_status="6.5";
		                  $send_email_and_text=TRUE;
								    }
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 7. Clean-Up Process.     *
 *--------------------------*/
              if (($C7_sub_step > 0) && ($C7_sub_step!=$repair_order_service_status_sub_step[7]))
                {
                  $note_text="";
                  if ($C7_sub_step==1)
                    {
                      $note_text="Clean-Up Process --> Awaiting clean-up";
                      $new_service_status="7.1";
                    }
								  if ($C7_sub_step==2)
								    {
								      $note_text="Clean-Up Process --> Working clean-up";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                        }
		                  $send_email_and_text=TRUE;
								      $new_service_status="7.2";
								    }
								  if ($C7_sub_step==3)
								    {
								      $note_text="Clean-Up Process --> Clean-Up complete";
								      $new_service_status="7.3";
								    }
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 8. QA Process.           *
 *--------------------------*/
              if (($C8_sub_step > 0) && ($C8_sub_step!=$repair_order_service_status_sub_step[8]))
                {
                  $note_text="";
                  if ($C8_sub_step==1)
                    {
                      $note_text="QA Process --> Awaiting QA";
                      $new_service_status="8.1";
                    }
				  				if ($C8_sub_step==2)
				  				  {
				  				    $note_text="QA Process --> Working QA";
                      if ($vehicle_owner_primary_email)
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                            {
                            	if ($carrier_id)
                            		{
                              		$note_text.=" (Customer has been notified via e-mail and text message.)";
                              	}
                              else
                              	{
                              		$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
                              	}
                            }
                          else
                            {
                              $note_text.=" (Customer has been notified via e-mail.)";
                            }
                        }
                      else
                        {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                        }
		                  $send_email_and_text=TRUE;
				  				    $new_service_status="8.2";
				  				  }
				  				if ($C8_sub_step==3)
				  				  {
				  				    $note_text="QA Process --> QA Complete";
				  				    $new_service_status="8.3";
				  				  }
                  if ($note_text) writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

/*--------------------------*
 * 9. Ready for Pick-Up.    *
 *--------------------------*/
              if (($C9=="X") && ($repair_order_service_status_id[9]==0))
                {
                  $note_text="Ready for Pick-Up";
                  if ($vehicle_owner_primary_email)
                    {
                      if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                        {
													if ($carrier_id)
														{
															$note_text.=" (Customer has been notified via e-mail and text message.)";
														}
													else
														{
															$note_text.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
														}
                        }
                      else
                        {
                          $note_text.=" (Customer has been notified via e-mail.)";
                        }
                    }
                  else
                    {
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$note_text.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$note_text.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}                    }
                  $new_service_status="9.0";
                  $send_email_and_text=TRUE;
                  writeNote($ro_id, $note_text, $lookup_user_id, $lookup_table_name);
                }

              if ($new_service_status)
                {
                  $new_service_status_sql="UPDATE repair_order SET date_updated=NOW(), last_update_user_id='$lookup_user_id', service_status='$new_service_status' WHERE id='$ro_id' LIMIT 1";
                  $new_service_status_result=mysql_query($new_service_status_sql,$db) or die (mysql_error()."<br>date_updated SQL= ".$new_service_status_sql);
                }

/*-------------------------------------------------------------------------------------------------------------*
 * 3Q 2007 Change: Add a note when a message is submitted even if the customer does not have an email address. *
 *-------------------------------------------------------------------------------------------------------------*/
              if ($email_message)
                {
                  $clean_email_message=mysql_real_escape_string($email_message);
                  $sql_note="MESSAGE TO CUSTOMER: $clean_email_message";
									if ($vehicle_owner_primary_email)
										{
											if ($send_text_message && $lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
												{
													if ($carrier_id)
														{
															$sql_note.=" (Customer has been notified via e-mail and text message.)";
														}
													else
														{
															$sql_note.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
														}
												}
											else
												{
                          if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
														{
                          		if ($carrier_id)
                          			{
                          				$sql_note.=" (Customer has been notified via text message.)";
                        				}
                        			else
                        				{
                        					$sql_note.=" (Customer has NOT been notified via text message - no Carrier selected.)";
                        				}
														}												}
										}
									else
										{
		                  if ($send_text_message && $lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                  	{
													if ($carrier_id)
														{
															$sql_note.=" (Customer has been notified via e-mail and text message.)";
														}
													else
														{
															$sql_note.=" (Customer has been notified via e-mail ONLY - no Carrier selected.)";
														}
		                  	}
											else
												{
													$sql_note.=" (Customer has NOT been notified.)";
												}
										}
                  $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'E', '$sql_note')";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>not notified SQL= ".$sql);

                  if ($vehicle_owner_primary_email)
                    {
                      $body="******************************\n";
                      $body.="A Note from My Repair Tracker\n";
                      $body.="*****************************\n";
                      $body.="\n";
                      $body.="Repair Order Number: $repair_order_number\n";
                      $body.="\n";
                      $body.=$clean_email_message."\n\n";
                      $body.="Please access My Repair Tracker at $reference_url, log on and use the Talk to Shop feature to reply to this message.\n";
                      $body.="\n";
					  					$body.="NOTE: This is an automated email from MyRepairTracker.com. Please do not reply directly to this system-generated email.\n";
                      $to=$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_primary_email.">";
                      if ($vehicle_owner_secondary_email)
                        {
                          $to.=", ".$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_secondary_email.">";
                        }
                      //$subject="$lookup_company_name: My Repair Tracker - Repair Order Update";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";
                      mail($to, $subject, $body, $headers);
                      $sql="UPDATE repair_order SET date_customer_status_checked=NOW() WHERE id=$ro_id LIMIT 1";
                      $result=mysql_query($sql,$db) or die (mysql_error()."<br>status check SQL= ".$sql);

											$log_subject=addslashes($subject);
											$log_body=addslashes($body);
											$log_to=addslashes($to);
											$log_headers=addslashes($headers);
                    	$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
                    	$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 2 SQL= ".$email_log_sql);
                    }
/*------------------------------------------------------------*
 * 1Q 2009 Change: Added support for optional text messaging. *
 *------------------------------------------------------------*/
                  if ($send_text_message && $lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
                    {
                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
                      $company_name=str_replace(" Body Shop", "", $company_name);
                      //$subject=$company_name;
                      $subject="Keeping You Informed";
                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $subject, $clean_email_message);
                    }
                }

              if ($override_date)
                {
                  $sql_note="TARGETED DELIVERY DATE OVERRIDE: There has been an extension to the completion date of repairs. New Targeted Delivery Date is $override_date.";
                  if ($vehicle_owner_primary_email)
                    {
/*---------------------------------------------------------------------------------------------*
 * If the Promise Date is being overriden ($override_date), add a note and email the customer. *
 *---------------------------------------------------------------------------------------------*/
                      $to=$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_primary_email.">";
                      if ($vehicle_owner_secondary_email)
                        {
                          $to.=", ".$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_secondary_email.">";
                        }
                      $body="******************************\n";
                      $body.="A Note from My Repair Tracker\n";
                      $body.="*****************************\n";
                      $body.="\n";
                      $body.="Repair Order Number: $repair_order_number\n";
                      $body.="\n";
                      $body.="There has been an extension to the completion date of repairs. New Targeted Delivery Date is $override_date.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.="\n";
                      $body.="Thank you for your business!\n";
                      $body.="\n";
					  					$body.="NOTE: This is an automated email from MyRepairTracker.com. Please do not reply directly to this system-generated email.\n";
                      //$subject="$lookup_company_name: My Repair Tracker - Targeted Delivery Date Updated";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";
                      mail($to, $subject, $body, $headers);
                      $sql="UPDATE repair_order SET date_customer_status_checked=NOW() WHERE id=$ro_id LIMIT 1";
                      $result=mysql_query($sql,$db) or die (mysql_error()."<br>email 3 SQL= ".$sql);
                      $sql_note.=" (Customer has been notified via e-mail.)";

											$log_subject=addslashes($subject);
											$log_body=addslashes($body);
											$log_to=addslashes($to);
											$log_headers=addslashes($headers);
                    	$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
                    	$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email 4 SQL= ".$email_log_sql);
                    }
                  $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'O', '$sql_note')";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>email history 5 SQL= ".$sql);
                }

/*------------------------------------------------------*
 * Send emails and text messages for specific statuses. *
 *------------------------------------------------------*/
              // if ($send_email_and_text && $vehicle_owner_primary_email)
              if ($send_email_and_text)
                {
                	$to="";
                  if ($vehicle_owner_primary_email)
                    {
                      $to=$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_primary_email.">";
                    }
                  if ($vehicle_owner_secondary_email)
                    {
                      $to.=", ".$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_secondary_email.">";
                    }

                  $body_header="******************************\n";
                  $body_header.="A Note from My Repair Tracker\n";
                  $body_header.="*****************************\n";
                  $body_header.="\n";
                  $body_header.="Repair Order Number: $repair_order_number\n";
                  $body_header.="\n";

                  $body_footer="\n";
                  $body_footer.="Thank you for your business!\n";
                  $body_footer.="\n";
                  $body_footer.="NOTE: This is an automated email from MyRepairTracker.com. Please do not reply directly to this system-generated email.\n";

/*-------------------------------*
 * Repair Authorization Obtained *
 *-------------------------------*/
                  if ($new_service_status=="1.3")
                    {
                      $body=$body_header;
                      $body.="Repair Authorization obtained.\n";
                      $body.="\n";
                      $body.="Thank you for allowing us to repair your vehicle. Our exclusive online Repair Tracker  will notify you electronically with repair updates and status. You can also check your repair status online at $reference_url by entering your last name and RO# (Repair Order). This will provide you with the most current repair status available.\n";
                      $body.="\n";
                      $body.="You can also use the \"Talk To Shop\" feature on your online repair tracking page to communicate with your Service Advisor.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Repair Authorization Obtained";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 5 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="We have obtained authorization to begin the repairs on your vehicle";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                    	SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*----------------------------------*
 * Body Repair Process: Disassembly *
 *----------------------------------*/
                  if ($new_service_status=="3.1")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is in the disassembly process.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Disassembly Started";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 6 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Your vehicle is in the disassembly process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                   	}
/*--------------------------------------*
 * Body Repair Process: Supplement hold *
 *--------------------------------------*/
                  if ($new_service_status=="3.3")
                    {
                      $body=$body_header;
                      $body.="While your vehicle was in the Body Repair Process we have requested a supplement for additional parts and/or labor needs from the providing insurance company and all repairs are on hold until authorization has been obtained.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Repairs on Hold (Body Repair Process)";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 7 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Repairs on hold in body repair process - waiting for authorization";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*------------------------------------*
 * Body Repair Process: Working Metal *
 *------------------------------------*/
                  if ($new_service_status=="3.6")
                    {
                      $body=$body_header;
                      $body.="We have started the repairs on your vehicle.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Working Metal";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 8 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="We have started the repairs on your vehicle";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*--------------------------------*
 * Paint Process: Supplement hold *
 *--------------------------------*/
                  if ($new_service_status=="4.1")
                    {
                      $body=$body_header;
                      $body.="While your vehicle was in the Paint Process we have requested a supplement for additional parts and/or labor needs from the providing insurance company and all repairs are on hold until authorization has been obtained.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Repairs on Hold (Paint Process)";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 9 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Repairs on hold in paint process - waiting for authorization";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*------------------------------*
 * Paint Process: Working Paint *
 *------------------------------*/
                  if ($new_service_status=="4.6")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is now in the paint process. This process can take up to 5 days.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Paint Process Started";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 10 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Your vehicle is now in the paint process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*-----------------------------*
 * Paint Process: Working Buff *
 *-----------------------------*/
                  if ($new_service_status=="4.8")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is now in the buffing process.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Buffing Process Started";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 11 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Your vehicle is now in the buffing process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*-------------------------------*
 * Paint Process: Paint Complete *
 *-------------------------------*/
                  if ($new_service_status=="4.9")
                    {
                      $body=$body_header;
                      $body.="The paint process for your vehicle is now complete.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Paint Process Started";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 12 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Paint process complete.";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*-------------------------------------*
 * Mechanical Process: Supplement hold *
 *-------------------------------------*/
                  if ($new_service_status=="5.1")
                    {
                      $body=$body_header;
                      $body.="While your vehicle was in the Mechanical Process we have requested a supplement for additional parts and/or labor needs from the providing insurance company and all repairs are on hold until authorization has been obtained.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Repairs on Hold (Mechanical Process)";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 13 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Repairs on hold in mechanical process - waiting for authorization";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*----------------------------------------*
 * Mechanical Process: Working mechanical *
 *----------------------------------------*/
                  if ($new_service_status=="5.4")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is now in the mechanical repair process.\n";
                      $body.="\n";
                      $body.="Thank you for allowing us to repair your vehicle. Our exclusive online Repair Tracker  will notify you electronically with repair updates and status. You can also check your repair status online at $reference_url by entering your last name and RO# (Repair Order). This will provide you with the most current repair status available.\n";
                      $body.="\n";
                      $body.="You can also use the \"Talk To Shop\" feature on your online repair tracking page to communicate with your Service Advisor.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Working Mechanical";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 14 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Vehicle in mechanical repair process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*----------------------------------------*
 * Mechanical Process: Working Suspension *
 *----------------------------------------*/
                  if ($new_service_status=="5.6")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is now in the suspension repair process.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Suspension Repairs Started";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 15 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Your vehicle is now in the suspension repair process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*-------------------------------------*
 * Reassembly Process: Supplement hold *
 *-------------------------------------*/
                  if ($new_service_status=="6.1")
                    {
                      $body=$body_header;
                      $body.="While your vehicle was in the Reassembly Process we have requested a supplement for additional parts and/or labor needs from the providing insurance company and all repairs are on hold until authorization has been obtained.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Repairs on Hold (Reassembly Process)";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 16 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Repairs on hold in reassembly process - waiting for authorization";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*----------------------------------*
 * Reassembly Process: Working trim *
 *----------------------------------*/
                  if ($new_service_status=="6.4")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is now in the reassembly process.\n";
                      $body.="\n";
                      $body.="Thank you for allowing us to repair your vehicle. Our exclusive online Repair Tracker  will notify you electronically with repair updates and status. You can also check your repair status online at $reference_url by entering your last name and RO# (Repair Order). This will provide you with the most current repair status available.\n";
                      $body.="\n";
                      $body.="You can also use the \"Talk To Shop\" feature on your online repair tracking page to communicate with your Service Advisor.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Working Trim";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>email log 17 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Vehicle in reassembly process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*-----------------------------------------*
 * Reassembly Process: Reassembly complete *
 *-----------------------------------------*/
                  if ($new_service_status=="6.5")
                    {
                      $body=$body_header;
                      $body.="The reassembly process for your vehicle is complete and has moved to the next stage of repair.\n";
                      $body.="\n";
                      $body.="Please check MyRepairTracker.com for the most current repair status by pointing your browser to $reference_url. Enter your last name, your repair order number and click the Submit button.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Repairs on Hold (Reassembly Process)";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>el 18 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Reassembly process complete";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*------------------------------------*
 * Clean-Up Process: Working clean-up *
 *------------------------------------*/
                  if ($new_service_status=="7.2")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is now in the clean-up process.\n";
                      $body.="\n";
                      $body.="Thank you for allowing us to repair your vehicle. Our exclusive online Repair Tracker  will notify you electronically with repair updates and status. You can also check your repair status online at $reference_url by entering your last name and RO# (Repair Order). This will provide you with the most current repair status available.\n";
                      $body.="\n";
                      $body.="You can also use the \"Talk To Shop\" feature on your online repair tracking page to communicate with your Service Advisor.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Clean-Up Process";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>el 19 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Vehicle in clean-up process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*------------------------------*
 * Clean-Up Process: Working QA *
 *------------------------------*/
                  if ($new_service_status=="8.2")
                    {
                      $body=$body_header;
                      $body.="Your vehicle is now in the quality assurance process.\n";
                      $body.="\n";
                      $body.="Thank you for allowing us to repair your vehicle. Our exclusive online Repair Tracker  will notify you electronically with repair updates and status. You can also check your repair status online at $reference_url by entering your last name and RO# (Repair Order). This will provide you with the most current repair status available.\n";
                      $body.="\n";
                      $body.="You can also use the \"Talk To Shop\" feature on your online repair tracking page to communicate with your Service Advisor.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Quality Assurance Process";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>el 20 SQL= ".$email_log_sql);
												}

		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Vehicle in quality assurance process";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*--------------------*
 * Ready for Pick Up. *
 *--------------------*/
                  if ($new_service_status=="9.0")
                    {
                      $body=$body_header;
                      $body.="Your Vehicle is ready for pick-up.\n";
                      $body.=$body_footer;
                      //$subject="$lookup_company_name: My Repair Tracker - Your Vehicle is Ready";
                      $subject="Keeping You Informed";
                      $headers = "From: $from\r\n";
                      // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";

                      if ($to)
                      	{
                      		mail($to, $subject, $body, $headers);
													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>el 21 SQL= ".$email_log_sql);
												}

                      $sql_note="READY FOR PICK-UP: Customer notified via email.";
                      if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone) $sql_note.=" Text message sent.";
                      $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'O', '$sql_note')";
                      $result=mysql_query($sql,$db) or die (mysql_error()."<br>el 22 SQL= ".$sql);
		                  if ($lookup_sms_allowed=="Y" && $vehicle_owner_texting_allowed=="Y" && $vehicle_owner_secondary_phone)
		                    {
                      		$text_message="Your vehicle is ready for pick-up";
		                      $company_name=str_replace(" Collision Center", "", $lookup_company_name);
		                      $company_name=str_replace(" Body Shop", "", $company_name);
		                      $text_subject=$company_name;
		                      SendTextMessage2($cookie_sp_id, $ro_id, "ro", $vehicle_owner_secondary_phone, $text_subject, $text_message);
		                    }
                    }
/*--------------------------------------------*
 * Update customer status checked date on RO. *
 *--------------------------------------------*/
                  $sql="UPDATE repair_order SET date_customer_status_checked=NOW() WHERE id=$ro_id LIMIT 1";
                  $result=mysql_query($sql,$db) or die (mysql_error()."<br>status_check 10 SQL= ".$sql);
                }

/*-------------------------*
 * Process the To Do List. *
 *-------------------------*/
              for ($i=1;$i<27;$i++)
                {
                  $j=$i;
                  if ($i==23) $j=59; // This accounts for the item Shop Rental added 5/18/2008
                  if ($i==24) $j=60; // This accounts for the item Parts Missing added 5/18/2008
                  if ($i==25) $j=61; // This accounts for the item Parts Pre-Order added 5/18/2010
                  if ($i==26) $j=62; // This accounts for the item Go Cars added 6/20/2010
                  $to_do_sql="";
                  $other_desc=addslashes($to_do_other_desc[$j]);
                  if ($original_to_do_id[$j]>0)
                    {
                      if ($to_do_status[$j]=="X")
                        {
                          $to_do_sql="DELETE FROM repair_order_to_do WHERE id='$original_to_do_id[$j]' LIMIT 1;";
                        }
                      else
                        {
                          $to_do_sql="UPDATE repair_order_to_do SET status='$to_do_status[$j]', other_desc='$other_desc', comment='$to_do_comment[$j]' WHERE id='$original_to_do_id[$j]' LIMIT 1;";
                        }
                    }
                  elseif ($to_do_status[$j]!="X")
                    {
                      $to_do_sql="INSERT INTO repair_order_to_do (date_added, last_update_user_id, repair_order_id, vehicle_to_do_id, status, other_desc, comment) VALUES (NOW(), '$lookup_user_id', '$ro_id', '$j', '$to_do_status[$j]', '$other_desc', '$to_do_comment[$j]');";
                    }
                  if ($to_do_sql)
                    {
                      $result=mysql_query($to_do_sql,$db) or die (mysql_error()."<br>ro_todo SQL= ".$to_do_sql."<br>Scrubbed: ".$other_desc."<br>Unscrubbed".$to_do_other_desc[$j]);
                    }
                }
				if (($parts_total > 0 || $parts_alternative > 0) && $_REQUEST["ems"])				{
					SendPartsNotice ($lookup_id, $lookup_user_id, $repair_order_number, $ems, $ro_id);
//mail("To:TracyM@ssysinc.com", "Parts Notice Test", "SendPartsNotice ($lookup_id, $lookup_user_id, $repair_order_number, '$ems'))",  "From: tracyM@ssysinc.com\r\n");

				}
            }
          // if (($status=="C") && ($date_closed=="0000-00-00 00:00:00"))
          if (($original_status=="O") && ($status=="C"))
            {
              if ($date_closed=="0000-00-00 00:00:00")
                {
                  if ($damage_assessment=="R")
                    {
                      $report_card_token=keyblock(10,1);
                      if ($vehicle_owner_primary_email)
                        {
                          $to=$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_primary_email.">";
                          if ($vehicle_owner_secondary_email)
                            {
                              $to.=", ".$vehicle_owner_first_name." ".$vehicle_owner_last_name." <".$vehicle_owner_secondary_email.">";
                            }
                          $body="******************************\n";
                          $body.="A Note from My Repair Tracker\n";
                          $body.="*****************************\n";
                          $body.="\n";
                          $body.="Repair Order Number: $repair_order_number\n";
                          $body.="\n";
                          $body.="Your Repair Order is now closed.\n";
                          $body.="\n";
                          $body.="We would appreciate you taking a minute or two to complete a Report Card for us. We value your input and we hope you take the time to let us know how we did! Just click the link below or copy and paste it into your browser to complete our simple Report Card:\n";
                          $body.="\n";
                          $body.= ENV_BASE_URL . "/report_card/?ro_id=$ro_id&report_card_token=$report_card_token\n";
                          $body.="\n";
                          $body.="Thank you for your business!\n";
                          $body.="\n";
                          $body.="NOTE: This is an automated email from MyRepairTracker.com. Please do not reply directly to this system-generated email.\n";
                          //$subject="$lookup_company_name: Repair Order Report Card";
                          $subject="Keeping You Informed";
                          $headers = "From: $from\r\n";
                          // $headers.="Bcc: Tim Hoover<timhoover12@tx.rr.com>, Karl Barger<tech_support@myrepairtracker.com>\r\n";
                          mail($to, $subject, $body, $headers);
                          $sql="UPDATE repair_order SET date_customer_status_checked=NOW() WHERE id=$ro_id LIMIT 1";
                          $result=mysql_query($sql,$db) or die (mysql_error()."<br>status_check 11 SQL= ".$sql);
                          $sql_note="RO CLOSED: CSI Report request sent";
                          $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'O', '$sql_note')";
                          $result=mysql_query($sql,$db) or die (mysql_error()."<br>csi SQL= ".$sql);

													$log_subject=addslashes($subject);
													$log_body=addslashes($body);
													$log_to=addslashes($to);
													$log_headers=addslashes($headers);
													$email_log_sql="INSERT INTO email_log (date_added, service_provider_id, repair_order_id, subject, body, `to`, headers) VALUES (NOW(), $lookup_id, $ro_id, '$log_subject', '$log_body', '$log_to', '$log_headers')";
													$email_log_result=mysql_query($email_log_sql,$db) or die (mysql_error()."<br>el 30 SQL= ".$email_log_sql);
                        }
                      else
                        {
                          $sql_note="RO CLOSED: CSI Report request sent NOT SENT because the Customer did not provide an email address";
                          $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'O', '$sql_note')";
                          $result=mysql_query($sql,$db) or die (mysql_error()."<br>csi no SQL= ".$sql);
                        }
                    }
                  else
                    {
                      $sql_note="RO CLOSED: CSI Report request sent NOT SENT because the vehicle was a Total Loss";
                      $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'O', '$sql_note')";
                      $result=mysql_query($sql,$db) or die (mysql_error()."<br>total loss SQL= ".$sql);
                    }
                }
              if ($beg_date && $end_date)
                {
                  $beg_yyyy=substr($beg_date,0,4);
                  $beg_mm=substr($beg_date,5,2);
                  $beg_dd=substr($beg_date,8,2);
                  $beg=mktime(0,0,0,$beg_mm,$beg_dd,$beg_yyyy);
                  $end_yyyy=substr($end_date,0,4);
                  $end_mm=substr($end_date,5,2);
                  $end_dd=substr($end_date,8,2);
                  $end=mktime(0,0,0,$end_mm,$end_dd - $labor_weekends_holidays,$end_yyyy);
                  $labor_days=(($end - $beg) / 86400);
                  $labor_time=($labor_hours_ri + $labor_hours_body + $labor_hours_paint + $labor_hours_mech + $labor_hours_trim + $labor_hours_frame);
                  if ($labor_days > 0)
                    {
                      $labor_actual_cycle_time=number_format(($labor_time / $labor_days),4,'.','');
                    }
                  elseif ($labor_days==0)
                    {
                      if ($labor_time > 0)
                        {
                          $labor_actual_cycle_time=1;
                        }
                      else
                        {
                          $labor_actual_cycle_time=0;
                        }
                    }
                  else
                    {
                      $labor_actual_cycle_time=0;
                    }
                }
/*-------------------------------------------------------------------------------*
 * 3Q 2012 Change: Remove the ability for the shops to override the data closed. *
 * This change was based on feedback from Darren that Tim sent to Karl on 7/5.   *
 *-------------------------------------------------------------------------------*/
              // if ($override_date_closed)
              //   {
              //     $date_closed=substr($override_date_closed,6,4)."-".substr($override_date_closed,0,2)."-".substr($override_date_closed,3,2);
              //     $sql="UPDATE repair_order SET date_closed='$date_closed'";
              //   }
              // else
              //   {
                  $sql="UPDATE repair_order SET date_closed=NOW()";
              //  }
              $sql.=", report_card_token='$report_card_token', labor_actual_cycle_time='$labor_actual_cycle_time', service_status='9.0' WHERE id='$ro_id' LIMIT 1";
              $result=mysql_query($sql,$db) or die (mysql_error()."<br> ro closed SQL= ".$sql);
            }
/*------------------------------------------------------------------------------*
 * 2Q 2007 Change: Go back to open list immediately instead of showing message. *
 *------------------------------------------------------------------------------*/
          $location=$BASE_HREF."ro_list.html?status=O";
					if ($ro_list_in_id)
						{
							$location.="&in_id=$ro_list_in_id";
						}
          if ($update || $update_too) header("Location: $location");
        }
    }
/*------------------------------------------------------------------------------------------------*
 * If the form was submitted and a full edit is not needed, check to see if the RO was re-opened. *
 *------------------------------------------------------------------------------------------------*/
  elseif (($update || $update_too) && ($full_edit==FALSE))
    {
      if ($original_status!=$status)
        {
/*--------------------------------------------------------------------------*
 * 2Q 2007 Change: When an RO is reopened reset the ready for pick up info. *
 *--------------------------------------------------------------------------*/
          if ($repair_order_service_status_sub_step[8]>0) $new_service_status="8.".$repair_order_service_status_sub_step[8];
          elseif ($repair_order_service_status_sub_step[7]>0) $new_service_status="7.".$repair_order_service_status_sub_step[7];
          elseif ($repair_order_service_status_sub_step[6]>0) $new_service_status="6.".$repair_order_service_status_sub_step[6];
          elseif ($repair_order_service_status_sub_step[5]>0) $new_service_status="5.".$repair_order_service_status_sub_step[5];
          elseif ($repair_order_service_status_sub_step[4]>0) $new_service_status="4.".$repair_order_service_status_sub_step[4];
          elseif ($repair_order_service_status_sub_step[3]>0) $new_service_status="3.".$repair_order_service_status_sub_step[3];
          elseif ($repair_order_service_status_sub_step[2]>0) $new_service_status="2.".$repair_order_service_status_sub_step[2];
          elseif ($repair_order_service_status_sub_step[1]>0) $new_service_status="1.".$repair_order_service_status_sub_step[1];
          else $new_service_status="0.0";
          $sql="UPDATE repair_order SET status='$status', date_updated=NOW(), date_closed='0000-00-00 00:00:00', report_card_token='', report_card_completed='N', report_card_a1='', report_card_a2='', report_card_a3='', report_card_a4='', report_card_a5='', report_card_a6='', report_card_comments='', report_card_yes_count=0, service_status='$new_service_status', service_status_9='', service_status_date_9='0000-00-00', service_status_sub_step_9=0, service_status_sub_step_date_9='0000-00-00' WHERE id='$ro_id' LIMIT 1";
          $result=mysql_query($sql,$db) or die (mysql_error()."<br>1 SQL= ".$sql);

          $sql="DELETE FROM repair_order_service_status WHERE (repair_order_id='$ro_id') AND (service_status='9') LIMIT 1";
          $result=mysql_query($sql,$db) or die (mysql_error()."<br>2SQL= ".$sql);

          $sql_note="RO REOPENED: Pick-Up and CSI Report data were reset";
          $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'O', '$sql_note')";
          $result=mysql_query($sql,$db) or die (mysql_error()."<br>3SQL= ".$sql);

          $sql_note="VEHICLE STATUS UPDATED: Repair Order was re-opened";
          $sql="INSERT INTO repair_order_history (date_added, last_update_table, last_update_user_id, repair_order_id, type, note) VALUES (NOW(), '$lookup_table_name', '$lookup_user_id', $ro_id, 'A', '$sql_note')";
          $result=mysql_query($sql,$db) or die (mysql_error()."<br>4SQL= ".$sql);

/*------------------------------------------------------------------------------*
 * 2Q 2007 Change: Go back to open list immediately instead of showing message. *
 *------------------------------------------------------------------------------*/
          $location=$BASE_HREF."ro_list.html?status=O";
					if ($ro_list_in_id)
						{
							$location.="&in_id=$ro_list_in_id";
						}
          header("Location: $location");
        }
    }
/*-----------------------------------------------*
 * If the form was not submitted, load the form. *
 *-----------------------------------------------*/
  else
    {
    	$repair_order_number="";
    	$original_repair_order_number="";
      $damage_assessment="R";
      $recall="N";
      $hot_file="N";
      $hail_damage="N";
      $fast_track="N";
      $eom="N";
      $cycle_time_vehicle="N";
      $multi_point_inspection="N";
      $bumper_only_job="N";
      $rework="N";
      $new_reminder_date="";
      $new_reminder_type="0";
      $promise_date_has_been_overridden="N";
      $repair_order_service_status_id=array();
      for ($i=1;$i<10;$i++)
        {
          $repair_order_service_status_id[$i]=0;
          $repair_order_service_status_sub_step_id[$i]=0;
          $repair_order_service_status_sub_step[$i]=0;
        }
			$labor_hours_ri=0;
			$labor_hours_body=0;
			$labor_hours_paint=0;
			$labor_hours_mech=0;
			$labor_hours_trim=0;
			$labor_hours_frame=0;
			$labor_sublet="0.00";
			$status="O";

			$message="<p class=\"noprint\">Complete the form below and click the Add button to add a new Repair Order to the database.";

/*-----------------------------------------------------------*
 * If a repair order id is in the URL, get it and query the  *
 * database. NOTE: The shop id is added to the query to make *
 * sure the selected RO belongs to the current shop.         *
 *-----------------------------------------------------------*/
			if ($_GET[ro_id])
        {
        	$ro_id=$_GET[ro_id];
          $ro_sql="SELECT * FROM repair_order WHERE (id='$ro_id') AND (service_provider_id='$cookie_sp_id') LIMIT 1";
          $errors[]="RO lookup $ro_id";
          $result=mysql_query($ro_sql,$db) or die (mysql_error()."<br>5SQL= ".$ro_sql);
          if ($row=mysql_fetch_array($result))
            {
              $ro_id=$row["id"];
              $ro=$row["repair_order_number"];
              $date_added=ReformatDate($row["date_added"]);
              $date_arrived=ReformatDate($row["date_arrived"]);
              $date_closed=$row["date_closed"];
              $status=$row["status"];
              $hot_file=$row["hot_file"];
              $hot_file_comment=$row["hot_file_comment"];
              $hail_damage=$row["hail_damage"];
              $hail_damage_comment=$row["hail_damage_comment"];
              $cycle_time_vehicle=$row["cycle_time_vehicle"];
              $cycle_time_vehicle_comment=$row["cycle_time_vehicle_comment"];
              $fast_track=$row["fast_track"];
              $fast_track_comment=$row["fast_track_comment"];
              $eom=$row["eom"];
              $eom_comment=$row["eom_comment"];
              $multi_point_inspection=$row["multi_point_inspection"];
              $multi_point_inspection_comment=$row["multi_point_inspection_comment"];
              $bumper_only_job=$row["bumper_only_job"];
              $bumper_only_job_comment=$row["bumper_only_job_comment"];
              $rework=$row["rework"];
              $rework_comment=$row["rework_comment"];
              $original_status=$row["status"];
              $original_service_status=$row["service_status"];
              $C1_sub_step=$row["service_status_sub_step_1"];
              $C2_sub_step=$row["service_status_sub_step_2"];
              $C3_sub_step=$row["service_status_sub_step_3"];
              $C4_sub_step=$row["service_status_sub_step_4"];
              $C5_sub_step=$row["service_status_sub_step_5"];
              $C6_sub_step=$row["service_status_sub_step_6"];
              $C7_sub_step=$row["service_status_sub_step_7"];
              $C8_sub_step=$row["service_status_sub_step_8"];
              $C9_sub_step=$row["service_status_sub_step_9"];
              $repair_order_service_status_sub_step[1]=$C1_sub_step;
              $repair_order_service_status_sub_step[2]=$C2_sub_step;
              $repair_order_service_status_sub_step[3]=$C3_sub_step;
              $repair_order_service_status_sub_step[4]=$C4_sub_step;
              $repair_order_service_status_sub_step[5]=$C5_sub_step;
              $repair_order_service_status_sub_step[6]=$C6_sub_step;
              $repair_order_service_status_sub_step[7]=$C7_sub_step;
              $repair_order_service_status_sub_step[8]=$C8_sub_step;
              $repair_order_service_status_sub_step[9]=$C9_sub_step;
              $repair_order_number=$row["repair_order_number"];
              $original_repair_order_number=$repair_order_number;
              $job_number=$row["job_number"];
              $claim_number=$row["claim_number"];
              $service_provider_advisor_id=$row["service_provider_advisor_id"];
              $service_provider_body_tech_id=$row["service_provider_body_tech_id"];
              $service_provider_paint_tech_id=$row["service_provider_paint_tech_id"];
              $service_provider_mech_tech_id=$row["service_provider_mech_tech_id"];
              $service_provider_trim_tech_id=$row["service_provider_trim_tech_id"];
              $vehicle_owner_first_name=$row["vehicle_owner_first_name"];
              $vehicle_owner_last_name=$row["vehicle_owner_last_name"];
              $vehicle_owner_primary_phone=$row["vehicle_owner_primary_phone"];
              $vehicle_owner_secondary_phone=$row["vehicle_owner_secondary_phone"];
              $vehicle_owner_primary_email=$row["vehicle_owner_primary_email"];
              $vehicle_owner_secondary_email=$row["vehicle_owner_secondary_email"];
              $vehicle_owner_email_allowed=$row["vehicle_owner_email_allowed"];
              $vehicle_owner_texting_allowed=$row["vehicle_owner_texting_allowed"];
							$carrier_id=$row["carrier_id"];

              $prev_vehicle_owner_primary_email=$vehicle_owner_primary_email;
              $prev_vehicle_owner_secondary_email=$vehicle_owner_secondary_email;
              $prev_vehicle_owner_secondary_phone=$vehicle_owner_secondary_phone;

              $vehicle_year=$row["vehicle_year"];
              $vehicle_make_id=$row["vehicle_make_id"];
              $vehicle_model=$row["vehicle_model"];
              $vehicle_color=$row["vehicle_color"];
              $vehicle_mileage=$row["vehicle_mileage"];
              $vehicle_vin=$row["vehicle_vin"];
              $vehicle_plate_no=$row["vehicle_plate_no"];
              $vehicle_gone_date=ReformatDate($row["vehicle_gone_date"]);
              $original_vehicle_gone_date=$vehicle_gone_date;
              $vehicle_insurance_id=$row["vehicle_insurance_id"];
              $damage_assessment=$row["damage_assessment"];
              $original_damage_assessment=$row["damage_assessment"];
              $recall=$row["recall"];
              $vehicle_damage_id=$row["vehicle_damage_id"];
              $vehicle_service_id=$row["vehicle_service_id"];
              $prior_damage_details=$row["prior_damage_details"];
              $total_loss_charges=$row["total_loss_charges"];
              $preliminary_repair_amount=$row["preliminary_repair_amount"];
              $revised_repair_amount=$row["revised_repair_amount"];
              $parts_total=$row["parts_total"];
              $parts_alternative=$row["parts_alternative"];
              $paint_materials=$row["paint_materials"];
              $ppg_total_cost=$row["ppg_total_cost"];
              $labor_dollars=$row["labor_dollars"];
              $pdr_dollars=$row["pdr_dollars"];
              $ri_dollars=$row["ri_dollars"];
              $scheduled_completion_date=$row["scheduled_completion_date"];
              $original_scheduled_completion_date=$row["scheduled_completion_date"];
              $revised_completion_date=$row["revised_completion_date"];
              $labor_cycle_time=$row["labor_cycle_time"];
              $labor_weekends_holidays=$row["labor_weekends_holidays"];
              $labor_hours_ri=$row["labor_hours_ri"];
              $labor_hours_body=$row["labor_hours_body"];
              $labor_hours_paint=$row["labor_hours_paint"];
              $labor_hours_mech=$row["labor_hours_mech"];
              $labor_hours_trim=$row["labor_hours_trim"];
              $labor_hours_frame=$row["labor_hours_frame"];
              $labor_sublet=$row["labor_sublet"];
              $labor_actual_cycle_time=$row["labor_actual_cycle_time"];
              $EMS_UNQFILE_ID=$row["EMS_UNQFILE_ID"];
              $clock_start_date="";
              $sql="SELECT * FROM repair_order_service_status WHERE repair_order_id=$ro_id ORDER BY service_status";
              $result=mysql_query($sql,$db) or die (mysql_error()."<br>6SQL= ".$sql);
              if ($row=mysql_fetch_array($result))
                {
                  do
                    {
                      $service_status_id=$row['id'];
                      $service_status=$row['service_status'];
                      $repair_order_service_status_id[$service_status]=$service_status_id;
                      if ($service_status==1)
                        {
                          $clock_start_date=$row['date_added'];
                          $beg_date=$clock_start_date;
                        }
                      if ($service_status==9) $end_date=$row['date_added'];
                    } while ($row=mysql_fetch_array($result));
                }
              if ($repair_order_service_status_id[1]>0) $C1='X';
              if ($repair_order_service_status_id[9]>0) $C9='X';
              if (strlen($clock_start_date)==0) $clock_start_date=date("Y-m-d H-i-s");
              if ($status=="O")
                {
                  $labor_actual_cycle_time="TBD";
                }
              $sql="SELECT COUNT(*) AS count FROM repair_order_history WHERE (repair_order_id=$ro_id) AND ((note LIKE 'PROMISE DATE OVERRIDE%') OR (note LIKE 'TARGETED DELIVERY DATE OVERRIDE%'))";
              $result=mysql_query($sql,$db) or die (mysql_error()."<br>7SQL= ".$sql);
              $row=mysql_fetch_array($result);
              $count=$row["count"];
              if ($count>0) $promise_date_has_been_overridden="Y";

/*----------------------*
 * Load the To Do List. *
 *----------------------*/
              $original_to_do_id=array();
              $original_to_do_status=array();
              $original_to_do_other_desc=array();
              $original_to_do_comment=array();
              $to_do_status=array();
              $to_do_other_desc=array();
              $to_do_comment=array();
              $to_do_sql="SELECT * FROM repair_order_to_do WHERE repair_order_id=$ro_id ORDER BY vehicle_to_do_id";
              $to_do_result=mysql_query($to_do_sql,$db) or die (mysql_error()."<br>8SQL= ".$to_do_sql);
              if ($to_do_row=mysql_fetch_array($to_do_result))
                {
                  do
                    {
                      $i=$to_do_row['vehicle_to_do_id'];
                      $original_to_do_id[$i]=$to_do_row['id'];
                      $original_to_do_status[$i]=$to_do_row['status'];
                      $original_to_do_other_desc[$i]=$to_do_row['other_desc'];
                      $original_to_do_comment[$i]=$to_do_row['comment'];
                      $to_do_status[$i]=$original_to_do_status[$i];
                      $to_do_other_desc[$i]=$original_to_do_other_desc[$i];
                      $to_do_comment[$i]=$original_to_do_comment[$i];
                    } while ($to_do_row=mysql_fetch_array($to_do_result));
                }
              $message="<p class=\"noprint\">Complete the form below and click the Update button to update the Repair Order in the database.";

              $sql="UPDATE repair_order SET unread_customer_msg='', unread_feedback_msg='', unread_insurance_msg='' WHERE id=$ro_id LIMIT 1";
              $result=mysql_query($sql,$db) or die (mysql_error()."<br>9SQL= ".$sql);
            }
          else
            {
              $ro_id="";
              $message="<p class=\"noprint\">That Repair Order was not found in the database. Complete the form below and click the Add button to add a new Repair Order to the database.";
            }
				}

/*--------------------------------------------------------------*
 * If an EMS file name is in the URL, get it and query the      *
 * database. NOTE: The shop id is checked after the AD1 record  *
 * is read to make sure the selected EMS belongs to the current *
 * shop.                                                        *
 *--------------------------------------------------------------*/
			if ($_GET["ems"])
				{
					$ems=$_GET["ems"];
					$ems_file=$ems.".AD1";
					$ad1=GetEMSData_AD1_sp($ems_file, $cookie_sp_id);
					if ($ad1[msg]=="NOTFOUND")
						{
							$message.="<p>That EMS File (<b>$ems</b>) was not found.</p>";
						}
					else
						{
							if ($cookie_sp_id==$ad1[service_provider_id])
								{
									if ($ad1[mrt_status]=="O")
										{
											$ems_file=$ems.".ENV";
											$env=GetEMSData_ENV_sp($ems_file, $cookie_sp_id);

                                                                                        $ems_est_type = trim($env["EST_SYSTEM"]);
echo "<!-- est system = $ems_est_type -->";

											$ems_repair_order_number=trim($env[RO_ID]);
											if ($repair_order_number)
												{
													if ($ems_repair_order_number=$repair_order_number)
														{
															// This EMS record matches the MRT RO, so
															// overlay the MRT RO values with the values
															// from the EMS RO.
														}
													else
														{
															// This EMS record does not match the MRT RO, so
															// we have a problem. The only time the URL should
															// have an ro_id and an ems is from the EMS files page.
															echo "*** SYSTEM ERROR ***<br />";
															echo "URL: $PHP_SELF<br />";
															echo "Shop Id: $lookup_id<br />";
															echo "RO # (DB): $repair_order_number<br />";
															echo "RO # (EMS): $ems_repair_order_number<br />";
															echo "<a href='" . ENV_BASE_URL . "/ro_list.html'>Go to the RO List and try again</a>";

															$body="*** SYSTEM ERROR ***\n";
															$body.="URL: $PHP_SELF\n";
															$body.="Shop Id: $lookup_id\n";
															$body.="RO # (DB): $repair_order_number\n";
															$body.="RO # (EMS): $ems_repair_order_number\n";
															$from="MyRepairTracker.com<website@myrepairtracker.com>";
															$subject="My Repair Tracker - SYSTEM ERROR (ro_sp.html)";
															$headers = "From: $from\r\n";
															$to="Karl Barger <tech_support@myrepairtracker.com>";
															mail($to, $subject, $body, $headers);
															exit();
														}
												}
											else
												{
													$repair_order_number=$ems_repair_order_number;
												}

											if ($status=="C")
												{
													$message.=" Since the RO is closed, the EMS updates have not been applied.";
												}
											else
												{
													$ems_file=$ems.".VEH";
													$veh=GetEMSData_VEH_sp($ems_file, $cookie_sp_id);

													$ems_file=$ems.".TTL";
													$ttl=GetEMSData_TTL_sp($ems_file, $cookie_sp_id);

													$ems_file=$ems.".AD2";
													$ad2=GetEMSData_AD2_sp($ems_file, $cookie_sp_id);

													$user_last_name=trim($ad2[EST_CT_LN]);
													$user_first_name=trim($ad2[EST_CT_FN]);
if (!$_GET[ro_id])
{
  												$select_sql="SELECT user_id FROM user WHERE ((user_type='Advisor') OR (user_type='Default Advisor') OR (user_type='Manager')) AND (user_status='A') AND (service_provider_id='$cookie_sp_id') AND (user_first_name='$user_first_name') AND (user_last_name='$user_last_name')";
													$result=mysql_query($select_sql,$db) or die (mysql_error()."<br>10 SQL= ".$select_sql);
													if ($row=mysql_fetch_array($result))
														{
															$service_provider_advisor_id=$row["user_id"];
														}
													else
														{
															$service_provider_advisor_id=0;
														}
}
													$vehicle_owner_first_name=trim($ad1[OWNR_FN]);
													$vehicle_owner_last_name=trim($ad1[OWNR_LN]);
													if (!$vehicle_owner_last_name)
														{
															$vehicle_owner_last_name=trim($ad1[OWNR_CO_NM]);
														}
													$vehicle_owner_primary_phone=formatPhone(trim($ad1[OWNR_PH1]));
													if (trim($ad1[OWNR_EA]))
														{
															$vehicle_owner_primary_email=strtolower(trim($ad1[OWNR_EA]));
														}

													$claim_number=trim($ad1[CLM_NO]);

													$preliminary_repair_amount=$ttl[PREV_NET];//N_TTL_AMT];
if ($preliminary_repair_amount == 0)
  $preliminary_repair_amount=$ttl[N_TTL_AMT];
                                                                                                        $revised_repair_amount=$ttl[SUPP_AMT];

													if (intval($veh[V_MODEL_YR]) < 26)
														{
															$vehicle_year="20".$veh[V_MODEL_YR];
														}
													else
														{
															$vehicle_year="19".$veh[V_MODEL_YR];
														}

													$vehicle_mileage=trim($veh[V_MILEAGE]);
													$vehicle_vin=trim($veh[V_VIN]);
													$vehicle_plate_no=trim($veh[PLATE_NO]);

if ($ems_est_type == "M") {
$sql="SELECT id FROM vehicle_make WHERE make ='$veh[V_MAKEDESC]' LIMIT 1;";
} else {

													$sql="SELECT id FROM vehicle_make WHERE pathways='$veh[V_MAKECODE]' LIMIT 1;";
}
													$result=mysql_query($sql,$db) or die (mysql_error()."<br>11 SQL= ".$sql);
													if ($row=mysql_fetch_array($result))
														{
															$vehicle_make_id=$row["id"];
														}
													else
														{
															$vehicle_make_id=0;
														}

if (!$_GET[ro_id])
{

													if (trim($ad1[INS_CO_NM]))
														{
															$ems_ins_co_nm=trim($ad1[INS_CO_NM]);
															$sql="SELECT vehicle_insurance_id FROM vehicle_insurance_ems_xref WHERE ems_ins_co_nm='$ems_ins_co_nm' LIMIT 1";
															$result=mysql_query($sql,$db) or die (mysql_error()."<br>12 SQL= ".$sql);
															if ($row=mysql_fetch_array($result))
																{
																	$vehicle_insurance_id=$row["vehicle_insurance_id"];
																}
															else
																{
																	$vehicle_insurance_id=69;
																}
														}
}

													$vehicle_model=trim($veh[V_MODEL]);
													$vehicle_color=trim($veh[V_COLOR]);
													$vehicle_vin=trim($veh[V_VIN]);

													$ems_file=$ems.".LIN";
													$labor_dollars=0;
													//
													// Get BODY Hours, accumulate LBR_AMT for labor dollars
													//
													$sql="SELECT SUM(MOD_LB_HRS) AS labor_hours_body, SUM(LBR_AMT) AS labor_dollars FROM _pathways_lin WHERE ems_file='$ems_file' AND (MOD_LBR_TY='LAB' OR MOD_LBR_TY='LAG' OR MOD_LBR_TY='LAS') and mrt_status = 'O'";
													$result=mysql_query($sql,$db) or die (mysql_error()."<br>13 SQL= ".$sql);
													if ($row=mysql_fetch_array($result))
														{
															$labor_hours_body=$row["labor_hours_body"];
															$labor_dollars=$labor_dollars + $row["labor_dollars"];
														}
													else
														{
															$labor_hours_body=0;
														}
													//
													// Get PAINT Hours, accumulate LBR_AMT for labor dollars
													//
													//$sql="SELECT SUM(MOD_LB_HRS) AS labor_hours_paint, SUM(LBR_AMT) AS labor_dollars FROM _pathways_lin WHERE ems_file='$ems_file' AND MOD_LBR_TY='LAR' and mrt_status = 'O'";

                                                                                                          $sql="select sum(ttl_hrs) as labor_hours_paint, sum(ttl_amt) as labor_dollars from _pathways_stl where ems_file like '$ems%' and mrt_status='O' and (service_provider_id='$cookie_sp_id') and ttl_type = 'TOT' and TTL_TYPECD in ('MAPA', 'MA2S', 'MA2T', 'MA3S', 'MABL')";
													$result=mysql_query($sql,$db) or die (mysql_error()."<br>14 SQL= ".$sql);
													if ($row=mysql_fetch_array($result))
														{
															$labor_hours_paint=$row["labor_hours_paint"];
															$labor_dollars=$labor_dollars + $row["labor_dollars"];
                              $paint_materials = $row["labor_dollars"];
														}
													else
														{
															$labor_hours_paint=0;
                              $paint_materials = 0;
														}

													//
													// Get MECH Hours, accumulate LBR_AMT for labor dollars
													//
													$sql="SELECT SUM(MOD_LB_HRS) AS labor_hours_mech, SUM(LBR_AMT) AS labor_dollars FROM _pathways_lin WHERE ems_file='$ems_file' AND (MOD_LBR_TY='LAD' OR MOD_LBR_TY='LAE' OR MOD_LBR_TY='LAM') and mrt_status = 'O'";
													$result=mysql_query($sql,$db) or die (mysql_error()."<br>15 SQL= ".$sql);
													if ($row=mysql_fetch_array($result))
														{
															$labor_hours_mech=$row["labor_hours_mech"];
															$labor_dollars=$labor_dollars + $row["labor_dollars"];
														}
													else
														{
															$labor_hours_mech=0;
														}
													//
													// Get FRAME Hours, accumulate LBR_AMT for labor dollars
													//
													$sql="SELECT SUM(MOD_LB_HRS) AS labor_hours_frame, SUM(LBR_AMT) AS labor_dollars FROM _pathways_lin WHERE ems_file='$ems_file' AND MOD_LBR_TY='LAF' and mrt_status = 'O'";
													$result=mysql_query($sql,$db) or die (mysql_error()."<br>16 SQL= ".$sql);
													if ($row=mysql_fetch_array($result))
														{
															$labor_hours_frame=$row["labor_hours_frame"];
															$labor_dollars=$labor_dollars + $row["labor_dollars"];
														}
													else
														{
															$labor_hours_frame=0;
														}
													//
													// Get OEM Parts Amount
													//
													$parts_total=number_format(ComputeEMSPartAmount("OEM", $ems, $lookup_id), 2, ".", "");
													//
													// Get Alternative Parts Amount
													//
													$parts_alternative=number_format(ComputeEMSPartAmount("ALT", $ems, $lookup_id), 2, ".", "");

													if ($ro_id)
														{
															$note="Updated from EMS record ($ems)";
														}
													else
														{
															$note="Created from EMS record ($ems)";
														}
												}
										}
									else
										{
											$message.="<p>That EMS File (<b>$ems</b>) has already been converted to an appointment, lead or RO. EMS status=".$ad1[mrt_status]."</p>";
										}
								}
							else
								{
									$message.="<p>That EMS File (<b>$ems</b>) does not belong to your shop.</p>";
								}
						}
				}
      $message.="</p>";
    }

  if ($ro_id>0)
    {
      $caption="Update";
      if (strlen($clock_start_date)==0) $clock_start_date=date("Y-m-d H:i:s");
      if ($original_status=="C")
        {
          $full_edit=FALSE;
          $disabled_attr="disabled";
        }
      else
        {
          $full_edit=TRUE;
          $disabled_attr="";
        }
    }
  else
    {
			$vehicle_owner_email_allowed="Y";
			$vehicle_owner_texting_allowed="Y";

      $caption="Add";
      $date_added=date("m-d-Y");
      $clock_start_date=date("Y-m-d H-i-s");
      $full_edit=TRUE;
      $disabled_attr="";

			if ($lookup_shop_type=="P" AND $service_provider_advisor_id==0)
				{
		      $default_tech_sql="SELECT user_id FROM user WHERE (service_provider_id=$cookie_sp_id) AND (user_first_name='Not') AND (user_last_name='Assigned') LIMIT 1";
		      $default_tech_result=mysql_query($default_tech_sql,$db) or die (mysql_error()."<br>16.5 SQL= ".$default_tech_sql);
		      if ($default_tech_row=mysql_fetch_array($default_tech_result))
		        {
		          $service_provider_advisor_id=$default_tech_row["user_id"];
		        }
				}

			if ($service_provider_body_tech_id==0)
				{
		      $default_tech_sql="SELECT id FROM service_provider_body_tech WHERE (service_provider_id=$cookie_sp_id) AND (first_name='Not') AND (last_name='Assigned') LIMIT 1";
		      $default_tech_result=mysql_query($default_tech_sql,$db) or die (mysql_error()."<br>17 SQL= ".$default_tech_sql);
		      if ($default_tech_row=mysql_fetch_array($default_tech_result))
		        {
		          $service_provider_body_tech_id=$default_tech_row["id"];
		        }
				}

			if ($service_provider_paint_tech_id==0)
				{
		      $default_tech_sql="SELECT id FROM service_provider_paint_tech WHERE (service_provider_id=$cookie_sp_id) AND (first_name='Not') AND (last_name='Assigned') LIMIT 1";
		      $default_tech_result=mysql_query($default_tech_sql,$db) or die (mysql_error()."<br>18 SQL= ".$default_tech_sql);
		      if ($default_tech_row=mysql_fetch_array($default_tech_result))
		        {
		          $service_provider_paint_tech_id=$default_tech_row["id"];
		        }
				}

			if ($service_provider_mech_tech_id==0)
				{
		      $default_tech_sql="SELECT id FROM service_provider_mech_tech WHERE (service_provider_id=$cookie_sp_id) AND (first_name='Not') AND (last_name='Assigned') LIMIT 1";
		      $default_tech_result=mysql_query($default_tech_sql,$db) or die (mysql_error()."<br>19 SQL= ".$default_tech_sql);
		      if ($default_tech_row=mysql_fetch_array($default_tech_result))
		        {
		          $service_provider_mech_tech_id=$default_tech_row["id"];
		        }
				}

			if ($service_provider_trim_tech_id==0)
				{
		      $default_tech_sql="SELECT id FROM service_provider_trim_tech WHERE (service_provider_id=$cookie_sp_id) AND (first_name='Not') AND (last_name='Assigned') LIMIT 1";
		      $default_tech_result=mysql_query($default_tech_sql,$db) or die (mysql_error()."<br>20 SQL= ".$default_tech_sql);
		      if ($default_tech_row=mysql_fetch_array($default_tech_result))
		        {
		          $service_provider_trim_tech_id=$default_tech_row["id"];
		        }
				}

			if ($lookup_shop_type=="P" AND $vehicle_insurance_id==0)
				{
					$vehicle_insurance_id=69; // *TBD
				}

    }
  $check_for_logo=TRUE;
  $include_cal=TRUE;
  $include_data_changed=TRUE;
	$include_reveal_hide=TRUE;
	$include_greybox=TRUE;
  $printable=TRUE;
  $page_heading=$lookup_company_name;
  include "includes/header.php";
  echo "<h3 class=\"noprint\">$caption Repair Order";
	if ($caption=="Update" && $EMS_UNQFILE_ID)
		{
			echo " | <a href=\"ro_sp_estimate.html?ro_id=$ro_id\">Estimate</a>";
			echo " | <a href=\"ro_sp_parts.html?ro_id=$ro_id\">Parts List</a>";
		}
  echo "</h3>\n";
  echo $message;

	if ($lookup_sms_allowed=="Y" && $vehicle_owner_secondary_phone  && !$carrier_id)
		{
			if ($ro_id)
				{
					echo "<center><div class=\"warning\">&nbsp;<br />NOTE: Changes to this RO will be allowed, this is just a warning.";
				}
			else
				{
					echo "<div class=\"warning\">&nbsp;<br />NOTE: Adding this RO will be allowed, this is just a warning.";
				}
			echo " MyRepairTracker.com <b>WILL NOT</b> be able to send text messages to customer until a Carrier is selected.<br />&nbsp;</div></center>\n";
		}

  if ($debug=="Y")
    {
      echo "<p>QUERY_STRING=$QUERY_STRING<br>";
      echo urldecode($QUERY_STRING);
      echo "<br>RO SQL=$ro_sql</p>";
    }
  if ($show_form==TRUE)
    {
?>
      <p class="noprint">Items marked with an <span class="red">asterisk (*)</span> are required.</p>
      <form name="example" action="<?php echo $PHP_SELF;?>" method="post">
<?php
  // echo "<input type=\"hidden\" name=\"repair_order_number\" value=\"$repair_order_number\">\n";
  echo "<input type=\"hidden\" name=\"full_edit\" value=\"$full_edit\">\n";
  echo "<input type=\"hidden\" name=\"ro_id\" value=\"$ro_id\">\n";
  // echo "<input type=\"hidden\" name=\"date_added\" value=\"$date_added\">\n";
  echo "<input type=\"hidden\" name=\"date_closed\" value=\"$date_closed\">\n";
  echo "<input type=\"hidden\" name=\"clock_start_date\" value=\"$clock_start_date\">\n";
  echo "<input type=\"hidden\" name=\"original_scheduled_completion_date\" value=\"$original_scheduled_completion_date\">\n";
  echo "<input type=\"hidden\" name=\"original_status\" value=\"$original_status\">\n";
  echo "<input type=\"hidden\" name=\"original_service_status\" value=\"$original_service_status\">\n";
  echo "<input type=\"hidden\" name=\"original_damage_assessment\" value=\"$original_damage_assessment\">\n";
	echo "<input type=\"hidden\" name=\"original_vehicle_gone_date\" value=\"$original_vehicle_gone_date\">\n";
  echo "<input type=\"hidden\" name=\"original_repair_order_number\" value=\"$original_repair_order_number\">\n";
  echo "<input type=\"hidden\" name=\"scheduled_completion_date\" value=\"$scheduled_completion_date\">\n";
  echo "<input type=\"hidden\" name=\"revised_completion_date\" value=\"$revised_completion_date\">\n";
  for ($i=1; $i<10; $i++)
    {
      echo "<input type=\"hidden\" name=\"repair_order_service_status_id[$i]\" value=\"$repair_order_service_status_id[$i]\">\n";
      echo "<input type=\"hidden\" name=\"repair_order_service_status_sub_step[$i]\" value=\"$repair_order_service_status_sub_step[$i]\">\n";
    }
  echo "<input type=\"hidden\" name=\"beg_date\" value=\"$beg_date\">\n";
  echo "<input type=\"hidden\" name=\"end_date\" value=\"$end_date\">\n";
  echo "<input type=\"hidden\" name=\"labor_actual_cycle_time\" value=\"$labor_actual_cycle_time\">\n";
  echo "<input type=\"hidden\" name=\"promise_date_has_been_overridden\" value=\"$promise_date_has_been_overridden\">\n";
  for ($i=1; $i<27; $i++)
    {
      $j=$i;
      if ($i==23) $j=59; // This accounts for the item Shop Rental added 5/18/2008
      if ($i==24) $j=60; // This accounts for the item Parts Missing added 5/18/2008
      if ($i==25) $j=61; // This accounts for the item Parts Pre-Order added 5/18/2010
      if ($i==26) $j=62; // This accounts for the item Go Cars added 6/20/2010
      echo "<input type=\"hidden\" name=\"original_to_do_id[$j]\" value=\"$original_to_do_id[$j]\">\n";
      echo "<input type=\"hidden\" name=\"original_to_do_status[$j]\" value=\"$original_to_do_status[$j]\">\n";
      echo "<input type=\"hidden\" name=\"original_to_do_other_desc[$j]\" value=\"$original_to_do_other_desc[$j]\">\n";
      echo "<input type=\"hidden\" name=\"original_to_do_comment[$j]\" value=\"$original_to_do_comment[$j]\">\n";
      echo "<input type=\"hidden\" name=\"to_do_status[$j]\" value=\"$to_do_status[$j]\">\n";
      echo "<input type=\"hidden\" name=\"to_do_other_desc[$j]\" value=\"$to_do_other_desc[$j]\">\n";
      echo "<input type=\"hidden\" name=\"to_do_comment[$j]\" value=\"$to_do_comment[$j]\">\n";
    }
  echo "<input type=\"hidden\" name=\"ro_list_in_id\" value=\"$ro_list_in_id\">\n";
  echo "<input type=\"hidden\" name=\"ro_list_status\" value=\"$ro_list_status\">\n";
  echo "<input type=\"hidden\" name=\"ro_list_page\" value=\"$ro_list_page\">\n";
  echo "<input type=\"hidden\" name=\"vehicle_owner_email_allowed\" value=\"$vehicle_owner_email_allowed\">\n";
  echo "<input type=\"hidden\" name=\"vehicle_owner_texting_allowed\" value=\"$vehicle_owner_texting_allowed\">\n";
	echo "<input type=\"hidden\" name=\"prev_vehicle_owner_primary_email\" value=\"$prev_vehicle_owner_primary_email\">\n";
	echo "<input type=\"hidden\" name=\"prev_vehicle_owner_secondary_email\" value=\"$prev_vehicle_owner_secondary_email\">\n";
	echo "<input type=\"hidden\" name=\"prev_vehicle_owner_secondary_phone\" value=\"$prev_vehicle_owner_secondary_phone\">\n";
  echo "<input type=\"hidden\" name=\"ems\" value=\"$ems\">\n";
  echo "<input type=\"hidden\" name=\"EMS_UNQFILE_ID\" value=\"$EMS_UNQFILE_ID\">\n";
	echo "<input type=\"hidden\" name=\"ppg_total_cost\" value=\"$ppg_total_cost\">\n";
?>
        <table align="center" border="0" cellpadding="2" style="border-collapse: collapse" width="100%">
          <tr>
            <td colspan="2" width="50%" valign="top">
              <fieldset>
                <legend>Repair Order Details and Assignments</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="98%">
                  <tr>
                    <td class="form_label" valign="top" width="30%">RO Status:</td>
                    <td valign="top" width="70%"><label for="status_o"><input id="status_o" type="radio" class="radio" name="status" value="O" <?php if ($status!="C") echo "checked";?> onclick="data_changed=true"> Opened</label> <label for="status_c"><input id="status_c" type="radio" class="radio" name="status" value="C" <?php if ($status=="C") echo "checked";?> onclick="data_changed=true"> Closed</label></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Date Opened:</td>
                    <td valign="top"><a href="#" onClick="cal.select(document.forms['example'].date_added,'cal0','MM-dd-yyyy'); return false;" name="cal0" id="cal0"><img alt="Click to select date" src="images/icon_calendar.gif" border="0"></a> <input readonly class="borderless bold" type="text" name="date_added" value="<?php echo $date_added;?>" size="10" onchange="data_changed=true"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Date Arrived:</td>
                    <td valign="top"><a href="#" onClick="cal.select(document.forms['example'].date_arrived,'cal2','MM-dd-yyyy'); return false;" name="cal2" id="cal2"><img alt="Click to select date" src="images/icon_calendar.gif" border="0"></a> <input readonly class="borderless bold" type="text" name="date_arrived" value="<?php echo $date_arrived;?>" size="10" onchange="data_changed=true"></td>
                  </tr>
                  <tr>
<?php
//  if (($status=="O") || ($original_status=="O"))
//    {
?>
<!--
                    <td class="form_label" valign="top">Date Closed:</td>
                    <td valign="top"><a href="#" onClick="cal.select(document.forms['example'].override_date_closed,'cal1','MM-dd-yyyy'); return false;" name="cal1" id="cal1"><img alt="Click to select date" src="images/icon_calendar.gif" border="0"></a> <input readonly class="borderless bold" type="text" name="override_date_closed" value="<?php // echo $override_date_closed;?>" size="10" onchange="data_changed=true"></td>
-->
<?php
//    }
?>
                  </tr>
<?php
  if ($status=="C")
    {
?>
                  <tr>
                    <td class="form_label" valign="top">Date Closed:</td>
                    <td valign="top"><?php echo ReformatDate($date_closed);?></td>
                  </tr>
<?php
    }
?>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>RO Number:</td>
                    <td valign="top"><input type="text" name="repair_order_number" size="20" maxlength="15" value="<?php echo $repair_order_number;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Advisor:</td>
                    <td valign="top">
                      <select <?php echo $disabled_attr;?> size="1" name="service_provider_advisor_id" onchange="data_changed=true" style="width: 100%;">
<?php
  if ($service_provider_advisor_id==0)
    {
      echo "<option value=\"\" selected>Select...</option>\n";
    }
  else
    {
      echo "<option value=\"\">Select...</option>\n";
    }
  $select_sql="SELECT * FROM user WHERE ((user_type='Advisor') OR (user_type='Default Advisor') OR (user_type='Manager')) AND (user_status='A') AND (service_provider_id='$cookie_sp_id') ORDER BY user_first_name, user_last_name";
  $select_result=mysql_query($select_sql,$db) or die (mysql_error()."<br>21 SQL= ".$select_sql);
  if ($select_row=mysql_fetch_array($select_result))
    {
      do
        {
          $select_id=$select_row["user_id"];
          $select_first_name=$select_row["user_first_name"];
          $select_last_name=$select_row["user_last_name"];
          $select_name=$select_row["user_first_name"]." ".$select_row["user_last_name"];
          if ($service_provider_advisor_id==$select_id)
            {
              echo "<option value=\"$select_id\" selected>$select_name</option>\n";
            }
          else
            {
              echo "<option value=\"$select_id\">$select_name</option>\n";
            }
        } while ($select_row=mysql_fetch_array($select_result));
    }
?>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Body Tech:</td>
                    <td valign="top">
                      <select <?php echo $disabled_attr;?> size="1" name="service_provider_body_tech_id" onchange="data_changed=true" style="width: 100%;">
<?php
  if ($service_provider_body_tech_id==0)
    {
      echo "<option value=\"\" selected>Select...</option>\n";
    }
  else
    {
      echo "<option value=\"\">Select...</option>\n";
    }
  $select_sql="SELECT * FROM service_provider_body_tech WHERE (status='A') AND (service_provider_id='$cookie_sp_id') ORDER BY first_name, last_name";
  $select_result=mysql_query($select_sql,$db) or die (mysql_error()."<br>22 SQL= ".$select_sql);
  if ($select_row=mysql_fetch_array($select_result))
    {
      do
        {
          $select_id=$select_row["id"];
          $select_first_name=$select_row["first_name"];
          $select_last_name=$select_row["last_name"];
          $select_name=$select_row["first_name"]." ".$select_row["last_name"];
          if ($service_provider_body_tech_id==$select_id)
            {
              echo "<option value=\"$select_id\" selected>$select_name</option>\n";
            }
          else
            {
              echo "<option value=\"$select_id\">$select_name</option>\n";
            }
        } while ($select_row=mysql_fetch_array($select_result));
    }
?>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Paint Tech:</td>
                    <td valign="top">
                      <select <?php echo $disabled_attr;?> size="1" name="service_provider_paint_tech_id" onchange="data_changed=true" style="width: 100%;">
<?php
  if ($service_provider_paint_tech_id==0)
    {
      echo "<option value=\"\" selected>Select...</option>\n";
    }
  else
    {
      echo "<option value=\"\">Select...</option>\n";
    }
  $select_sql="SELECT * FROM service_provider_paint_tech WHERE (status='A') AND (service_provider_id='$cookie_sp_id') ORDER BY first_name, last_name";
  $select_result=mysql_query($select_sql,$db) or die (mysql_error()."<br>23 SQL= ".$select_sql);
  if ($select_row=mysql_fetch_array($select_result))
    {
      do
        {
          $select_id=$select_row["id"];
          $select_first_name=$select_row["first_name"];
          $select_last_name=$select_row["last_name"];
          $select_name=$select_row["first_name"]." ".$select_row["last_name"];
          if ($service_provider_paint_tech_id==$select_id)
            {
              echo "<option value=\"$select_id\" selected>$select_name</option>\n";
            }
          else
            {
              echo "<option value=\"$select_id\">$select_name</option>\n";
            }
        } while ($select_row=mysql_fetch_array($select_result));
    }
?>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Mechanical Tech:</td>
                    <td valign="top">
                      <select <?php echo $disabled_attr;?> size="1" name="service_provider_mech_tech_id" onchange="data_changed=true" style="width: 100%;">
<?php
  if ($service_provider_mech_tech_id==0)
    {
      echo "<option value=\"\" selected>Select...</option>\n";
    }
  else
    {
      echo "<option value=\"\">Select...</option>\n";
    }
  $select_sql="SELECT * FROM service_provider_mech_tech WHERE (status='A') AND (service_provider_id='$cookie_sp_id') ORDER BY first_name, last_name";
  $select_result=mysql_query($select_sql,$db) or die (mysql_error()."<br>24 SQL= ".$select_sql);
  if ($select_row=mysql_fetch_array($select_result))
    {
      do
        {
          $select_id=$select_row["id"];
          $select_first_name=$select_row["first_name"];
          $select_last_name=$select_row["last_name"];
          $select_name=$select_row["first_name"]." ".$select_row["last_name"];
          if ($service_provider_mech_tech_id==$select_id)
            {
              echo "<option value=\"$select_id\" selected>$select_name</option>\n";
            }
          else
            {
              echo "<option value=\"$select_id\">$select_name</option>\n";
            }
        } while ($select_row=mysql_fetch_array($select_result));
    }
?>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Trim Tech:</td>
                    <td valign="top">
                      <select <?php echo $disabled_attr;?> size="1" name="service_provider_trim_tech_id" onchange="data_changed=true" style="width: 100%;">
<?php
  if ($service_provider_trim_tech_id==0)
    {
      echo "<option value=\"\" selected>Select...</option>\n";
    }
  else
    {
      echo "<option value=\"\">Select...</option>\n";
    }
  $select_sql="SELECT * FROM service_provider_trim_tech WHERE (status='A') AND (service_provider_id='$cookie_sp_id') ORDER BY first_name, last_name";
  $select_result=mysql_query($select_sql,$db) or die (mysql_error()."<br>25 SQL= ".$select_sql);
  if ($select_row=mysql_fetch_array($select_result))
    {
      do
        {
          $select_id=$select_row["id"];
          $select_first_name=$select_row["first_name"];
          $select_last_name=$select_row["last_name"];
          $select_name=$select_row["first_name"]." ".$select_row["last_name"];
          if ($service_provider_trim_tech_id==$select_id)
            {
              echo "<option value=\"$select_id\" selected>$select_name</option>\n";
            }
          else
            {
              echo "<option value=\"$select_id\">$select_name</option>\n";
            }
        } while ($select_row=mysql_fetch_array($select_result));
    }
?>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Insurance:</td>
                    <td valign="top">
<?php
  echo "<select $disabled_attr size=\"1\" name=\"vehicle_insurance_id\" onchange=\"data_changed=true\" style=\"width: 100%;\">\n";
  if ($vehicle_insurance_id==0)
    {
      echo "<option value=\"\" selected>Select...</option>\n";
    }
  else
    {
      echo "<option value=\"\">Select...</option>\n";
    }
  $select_sql="SELECT * FROM vehicle_insurance WHERE shop_type='C' ORDER BY insurance";
  $select_result=mysql_query($select_sql,$db) or die (mysql_error()."<br>26 SQL= ".$select_sql);
  if ($select_row=mysql_fetch_array($select_result))
    {
      do
        {
          $select_id=$select_row["id"];
          $select_insurance=htmlentities($select_row["insurance"]);
          if ($vehicle_insurance_id==$select_id)
            {
              echo "<option value=\"$select_id\" selected>$select_insurance</option>\n";
            }
          else
            {
              echo "<option value=\"$select_id\">$select_insurance</option>\n";
            }
        } while ($select_row=mysql_fetch_array($select_result));
    }
  echo "</select>\n";
?>
                    </td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Claim Number:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="claim_number" size="20" maxlength="50" value="<?php echo $claim_number;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                </table>
              </fieldset>
            </td>
            <td colspan="2" width="50%" valign="top">
            
            <link rel="stylesheet" type="text/css" href="_css/vehiclephoto.css" media="screen">
			<link rel="stylesheet" type="text/css" href="uploadify/uploadify.css" />
			<link rel="stylesheet" type="text/css" href="uploadify5/uploadifive.css">
            <script type="text/javascript" src="uploadify/jquery.uploadify-3.1.min.js"></script>
			<script src="uploadify5/jquery.uploadifive.min.js" type="text/javascript"></script>
			<script src="_js/modernizr-2.0.6.min.js" type="text/javascript"></script>
              <fieldset>
	            <legend>Vehicle Photos</legend>
	              <table align="left" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse">
	                <tr>
	                	<td>
<!-- 							<form> -->
								<div id="queue" style="display:none;"></div>
								<input type="file" name="uploadify" id="uploadify" style="display:none;" />
								<input id="uploadifive" name="uploadifive" type="file" multiple="true">
<!-- 							</form> -->
	                	</td>
	                	<td id="service_images">
	                	<?php
	                		$id = $ro_id;
	                		$type = 'r';
	                		$user = 'a';
	                		include('getimages.php');
	                	?>
	                	</td>
	                </tr>
	              </table>
              </fieldset>
          
              <script type="text/javascript" src="/_js/vehiclephoto.js"></script>
	          <script type="text/javascript">
	          	jQuery(document).ready(function($) {
          		
		          	$(document).on("mouseenter", '.cellImage', function(){ $(this).find('.deleteImage').fadeIn(); })
		          		       .on("mouseleave", '.cellImage', function(){ $(this).find('.deleteImage').stop().fadeOut(); }
		          	);
		          	
		          	$(document).on("click", '.deleteImage', function(){
		          		var image_id = $(this).attr('name').substr(3);
		          		var parentTD = $(this).parent();
			          	if (confirm('Are you sure you wish to delete this image?')) {
				          	$.post("deleteimage.php", {'type':'r','image_id':image_id}, function(data) {
				          		if (data=="") {
					          		parentTD.remove();
					          	} else {
						          	alert(data);
					          	}
				          	})
			          	}
		          	});
	          	          	
					<?php $timestamp = time();?>
					$(function() {
						var ro_type = 'r';
						var _optionsUploadify = {
							'auto'         : true,
							'formData'     : {
												'timestamp' : '<?php echo $timestamp;?>',
												'token'     : '<?php echo md5('unique_salt' . $timestamp);?>',
												'id'        : '<?php echo $ro_id; ?>',
												'type'      : ro_type,
												'prefix'    : ro_type+'_'
							},
							'queueID'  : 'queue',
							'swf'      : 'uploadify/uploadify.swf',
							'uploader' : 'uploadify/uploadify.php',
							'onUploadSuccess' : function(file, data, response) {
								$.get("getimages.php", {'type':ro_type,'user':'a','id':<?php echo $ro_id; ?>},function(data) {
									$('#service_images').html(data);
								});
			            	}
						}
					    
						var _optionsUploadifive = {
							'auto'             : true,
							'formData'         : {
												   'timestamp' : '<?php echo $timestamp;?>',
												   'token'     : '<?php echo md5('unique_salt' . $timestamp);?>',
												   'id'        : '<?php echo $ro_id; ?>',
												   'type'      : ro_type,
												   'prefix'    : ro_type+'_'
							                     },
							'queueID'          : 'queue',
							'uploadScript'     : 'uploadify5/uploadifive.php',
							'onUploadComplete' : function(file, data) { 
								$.get("getimages.php", {'type':ro_type,'user':'a','id':<?php echo $ro_id; ?>},function(data) {
									$('#service_images').html(data);
								});
							}, 
							'onFallback'       : function() {
								$('#uploadifive').hide();
								$('#uploadify').show();
								$("#uploadify").uploadify(_optionsUploadify); // browser has failed the test, lets use Uploadify instead
							}
						};
/* 						$("#uploadify").uploadify(_optionsUploadify); */
						$("#uploadifive").uploadifive(_optionsUploadifive); // HTML5 enabled browsers will pass the pretest and fire this instead
					});
	          	});
			</script>
              <fieldset>
                <legend>Task Reminders</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="98%">
                  <tr>
                    <td class="form_label" valign="top" width="30%">Reminder Date:</td>
                    <td valign="top" width="70%">
<?php
  if ($disabled_attr)
    {
?>
                      <img alt="New task reminder is not allowed for closed ROs" src="images/icon_calendar.gif" border="0">
<?php
    }
  else
    {
?>
                      <a href="#" onClick="cal4.select(document.forms['example'].new_reminder_date,'cal4','MM-dd-yyyy'); return false;" name="cal4" id="cal4"><img alt="Click to select date" src="images/icon_calendar.gif" border="0"></a> <input readonly class="borderless bold" type="text" name="new_reminder_date" value="<?php echo $new_reminder_date;?>" size="10" onchange="data_changed=true">
<?php
    }
?>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Reminder Type:</td>
                    <td valign="top"><?php echo SelectReminder($new_reminder_type, "new_reminder_type", $disabled_attr);?></td>
                  </tr>
                </table>
              </fieldset>
              <fieldset>
                <legend>Open Task Reminders</legend>
<?php
	if ($ro_id)
		{
		  $now=date("Y-m-d");
		  $reminder_sql="SELECT * FROM reminder WHERE repair_order_id='$ro_id' ORDER BY reminder_date, id";
		  $reminder_result=mysql_query($reminder_sql,$db) or die (mysql_error()."<br>27 SQL= ".$reminder_sql);
		  if ($reminder_row=mysql_fetch_array($reminder_result))
		    {
		      $reminder_list="<div class=\"black center smallest\">To Delete or Close a Reminder click the check box beside the Reminder</div>\n";
		      $reminder_list.="<table border=\"0\" cellpadding=\"1\" cellspacing=\"1\" style=\"border-collapse: collapse\">\n";
		      $reminder_list.="<tr>\n";
		      $reminder_list.="</tr>\n";
		      $seq=0;
		      do
		        {
		          $checked="";
		          if ($reminder_del[$seq]=="X") $checked=" checked";
			        $reminder_list.="<tr>\n";
		          $reminder_list.="<td class=\"center\"><input $disabled_attr type=\"checkbox\" class=\"checkbox\" name=\"reminder_del[$seq]\" value=\"X\"$checked><input type=\"hidden\" name=\"reminder_id[$seq]\" value=\"".$reminder_row["id"]."\"></td>\n";
		          $reminder_list.="<td class=\"center\"><img alt=\"Reminder\" border=\"0\" src=\"images/icon_flag_red.gif\" height=\"16\" width=\"16\"></td>\n";
		          $reminder_list.="<td class=\"center\"><span class=\"bold\">".ReformatDate($reminder_row["reminder_date"])."</span></td>\n";
		          $reminder_list.="<td>".DecodeReminder($reminder_row["reminder_type"])."</td>\n";
		          $reminder_list.="</tr>\n";
		          $seq++;
		        } while ($reminder_row=mysql_fetch_array($reminder_result));
		      $reminder_list.="</table>\n";
		    }
		  else
		    {
		      $reminder_list="<div class=\"black center smallest\">There are no Open Task Reminders on file for this Repair Order.</div>\n";
		    }
		}
  else
  	{
			$reminder_list="<div class=\"black center smallest\">There are no Open Task Reminders on file for this Repair Order.</div>\n";
		}
  echo $reminder_list;
?>
              </fieldset>
            </td>
          </tr>
          <tr>
            <td colspan="2" width="50%" valign="top">
              <fieldset>
                <legend>Vehicle Owner's Details</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="98%">
                  <tr>
                   <td class="form_label" valign="top" width="30%">First Name:</td>
                    <td valign="top" width="70%"><input <?php echo $disabled_attr;?> type="text" name="vehicle_owner_first_name" size="20" maxlength="50" value="<?php echo $vehicle_owner_first_name;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Company -OR- Last Name:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="vehicle_owner_last_name" size="20" maxlength="50" value="<?php echo $vehicle_owner_last_name;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Phone Number:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" id="vehicle_owner_primary_phone" class="formatPhone10" name="vehicle_owner_primary_phone" size="20" maxlength="25" value="<?php echo $vehicle_owner_primary_phone;?>" onchange="data_changed=true" style="width: 25%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Cell Phone Number / Carrier<?php if ($vehicle_owner_texting_allowed=="N") { echo " <img alt=\"Customer has opted out from receiving text messages\" title=\"Customer has opted out from receiving text messages\" src=\"images/no_contact.png\">"; } ?>:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" id="vehicle_owner_secondary_phone" class="formatPhone10" name="vehicle_owner_secondary_phone" size="20" maxlength="25" value="<?php echo $vehicle_owner_secondary_phone;?>" onchange="data_changed=true" style="width: 25%;"><?php echo SelectCarrier($carrier_id, "carrier_id", $disabled_attr);?> <span class="smallest"><a title="Carrier not listed? Click here to contact us. NOTE: New window/tab will open." href="contact_us/" target="_blank">Carrier not listed? Click here to contact us.</a></span></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Primary Email<?php if ($vehicle_owner_email_allowed=="N") { echo " <img alt=\"Customer has opted out from receiving email messages\" title=\"Customer has opted out from receiving email messages\" src=\"images/no_contact.png\">"; } ?>:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="vehicle_owner_primary_email" size="20" maxlength="100" value="<?php echo $vehicle_owner_primary_email;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Secondary Email<?php if ($vehicle_owner_email_allowed=="N") { echo " <img alt=\"Customer has opted out from receiving email messages\" title=\"Customer has opted out from receiving email messages\" src=\"images/no_contact.png\">"; } ?>:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="vehicle_owner_secondary_email" size="20" maxlength="100" value="<?php echo $vehicle_owner_secondary_email;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                </table>
              </fieldset>
            </td>
            <td colspan="2" valign="top" width="50%">
              <fieldset>
                <legend>Vehicle Details and Tag Number</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="98%">
                  <tr>
                    <td class="form_label" valign="top" width="30%"><span class="red">*</span>Year:</td>
                    <td valign="top" colspan="3" width="70%"><?php echo SelectYear($vehicle_year, "vehicle_year", $disabled_attr);?></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Make:</td>
                    <td valign="top" colspan="3" ><?php echo SelectVehicleMake($vehicle_make_id, "vehicle_make_id", $disabled_attr);?></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top"><span class="red">*</span>Model:</td>
                    <td valign="top" width="25%"><input <?php echo $disabled_attr;?> type="text" name="vehicle_model" size="20" maxlength="50" value="<?php echo $vehicle_model;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  	<td class="form_label" valign="top" width="25%">Plate:</td>
                  	<td valign="top" width="20%"><input <?php echo $disabled_attr;?> type="text" name="vehicle_plate_no" size="20" maxlength="10" value="<?php echo $vehicle_plate_no;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Color:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="vehicle_color" size="20" maxlength="50" value="<?php echo $vehicle_color;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  	<td class="form_label" valign="top">VIN:</td>
                  	<td valign="top"><input <?php echo $disabled_attr;?> type="text" name="vehicle_vin" size="20" maxlength="17" value="<?php echo $vehicle_vin;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Tag Number:</td>
                    <td valign="top" colspan="3"><input <?php echo $disabled_attr;?> type="text" name="job_number" size="20" maxlength="10" value="<?php echo $job_number;?>" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Mileage:</td>
                    <td valign="top" colspan="3"><input <?php echo $disabled_attr;?> type="text" name="vehicle_mileage" size="10" maxlength="10" value="<?php echo $vehicle_mileage;?>" onkeypress="return checkForInt(event)" onchange="data_changed=true" style="width: 100%;"></td>
                  </tr>
                </table>
              </fieldset>
            </td>
          </tr>
          <tr>
            <td colspan="4" width="100%">
              <fieldset>
                <legend>Estimate Summary</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="100%">
                  <tr>
                    <td class="form_label" valign="top">Damage Assessment:</td>
                    <td valign="top"><label for="damage_r"><input id="damage_r" <?php echo $disabled_attr;?> type="radio" class="radio" name="damage_assessment" value="R" <?php if ($damage_assessment=="R") echo "checked";?> onclick="data_changed=true"><span class="blue bold">&nbsp;Repairable</span></label> <label for="damage_tl"><input id="damage_tl" <?php echo $disabled_attr;?> type="radio" class="radio" name="damage_assessment" value="TL" <?php if ($damage_assessment=="TL") echo "checked";?> onclick="data_changed=true"><span class="blue bold">&nbsp;Total Loss</span></label>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;<label for="recall"><input id="recall" <?php echo $disabled_attr;?> type="checkbox" class="checkbox" name="recall" value="Y" <?php if ($recall=="Y") echo "checked";?> onclick="data_changed=true"><span class="blue bold">&nbsp;Recall</span></label></td>
                    <td class="form_label" valign="top">Total Loss Charges:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="total_loss_charges" size="10" maxlength="10" value="<?php echo $total_loss_charges;?>" onkeypress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"></td>
                    <td class="form_label" valign="top">Primary Damage:</td>
                    <td valign="top">
<?php
  echo "<select $disabled_attr size=\"1\" name=\"vehicle_damage_id\" onchange=\"data_changed=true\">\n";
  if ($vehicle_damage_id==0)
    {
      echo "<option value=\"0\" selected>Select...</option>\n";
    }
  else
    {
      echo "<option value=\"0\">Select...</option>\n";
    }
  $select_sql="SELECT * FROM vehicle_damage ORDER BY sort_order";
  $select_result=mysql_query($select_sql,$db) or die (mysql_error()."<br>28 SQL= ".$select_sql);
  if ($select_row=mysql_fetch_array($select_result))
    {
      do
        {
          $select_id=$select_row["id"];
          $select_damage=htmlentities($select_row["damage"]);
          if ($vehicle_damage_id==$select_id)
            {
              echo "<option value=\"$select_id\" selected>$select_damage</option>\n";
            }
          else
            {
              echo "<option value=\"$select_id\">$select_damage</option>\n";
            }
        } while ($select_row=mysql_fetch_array($select_result));
    }
  echo "</select>\n";
?>
                    </td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Prior Damage Details:</td>
                    <td colspan="5" valign="top"><input <?php echo $disabled_attr;?> type="text" name="prior_damage_details" size="100" maxlength="100" value="<?php echo $prior_damage_details;?>" onchange="data_changed=true"></td>
                  </tr>
                  <tr>
<?php
	if ($lookup_shop_type=="P")
		{
?>
                    <td class="form_label" valign="top">Conv $ / PDR $ / R&amp;I $:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="preliminary_repair_amount" size="10" maxlength="10" value="<?php echo $preliminary_repair_amount;?>" onkeypress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"> <input <?php echo $disabled_attr;?> type="text" name="pdr_dollars" size="10" maxlength="10" value="<?php echo $pdr_dollars;?>" onkeypress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"> <input <?php echo $disabled_attr;?> type="text" name="ri_dollars" size="10" maxlength="10" value="<?php echo $ri_dollars;?>" onkeypress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"></td>
<?php
		}
	else
		{
?>
                    <td class="form_label" valign="top">Preliminary Repair Amount:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="preliminary_repair_amount" size="10" maxlength="10" value="<?php echo $preliminary_repair_amount;?>" onkeypress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"></td>
<?php
		}
?>
										<td class="form_label" valign="top">Supplement(s):</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="revised_repair_amount" size="10" maxlength="10" value="<?php echo $revised_repair_amount;?>" onkeypress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"></td>
<?php
  $total_repair_amount=number_format(($preliminary_repair_amount + $revised_repair_amount),2,'.',',');
?>
                    <td class="form_label" valign="top">Total Severity:</td>
                    <td class="bold" valign="top"><?php echo '$'.$total_repair_amount;?></td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Parts (OEM):</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="parts_total" size="10" maxlength="10" value="<?php echo $parts_total;?>" onKeyPress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"> <span class="smallest" style="padding-left: 50px;"><a title="Can't enter dollar amounts? Click here for help." href="help/amounts.html" rel="gb_page_center[500, 400]"><img border="0" src="images/help.gif" width="11" height="11" alt="Can't enter dollar amounts? Click here for help."> Can't enter dollar amounts? Click here for help.</a></span></td>
                    <td class="form_label" valign="top">Alternative Parts:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="parts_alternative" size="10" maxlength="10" value="<?php echo $parts_alternative;?>" onKeyPress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"></td>
<?php
  if (($parts_total>0) AND ($parts_alternative>0))
    {
      $alternative_parts_used_percent=number_format((($parts_alternative / ($parts_total+ $parts_alternative)) * 100),2,'.','');
    }
  else
    {
      $alternative_parts_used_percent="0.0";
    }
  $alternative_parts_used_percent_class="bold";
  if ($alternative_parts_used_percent < 28) $alternative_parts_used_percent_class.=" red";

	$diff_paint_materials="";
	$paint_materials_details="<span class=\"blue bold\">Paint &amp; Materials Actual: $" . number_format($ppg_total_cost, 2) . "</span>";
	if ($paint_materials < $ppg_total_cost)
		{
			$diff_paint_materials="<span class=\"red bold\">&nbsp;&nbsp;&nbsp;Paint &amp; Materials Diff: -$" . number_format(abs($paint_materials - $ppg_total_cost), 2) . "</span>";
		}
?>
                    <td class="form_label" valign="top">Alternative Parts Used:</td>
                    <td class="<?php echo $alternative_parts_used_percent_class;?>" valign="top"><?php echo $alternative_parts_used_percent;?>%</td>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Estimated Paint &amp; Materials:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="paint_materials" size="10" maxlength="10" value="<?php echo $paint_materials;?>" onKeyPress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"> <span style="padding-left: 50px;"><?php echo $paint_materials_details;?></span><?php echo $diff_paint_materials;?></td>
                    <td class="form_label" valign="top">Labor Dollars:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_dollars" size="10" maxlength="10" value="<?php echo $labor_dollars;?>" onKeyPress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"></td>
                    <td class="form_label" valign="top">&nbsp;</td>
                    <td valign="top">&nbsp;</td>
                  </tr>
                </table>
              </fieldset>
            </td>
          </tr>
          <tr>
            <td colspan="4" width="100%">
              <fieldset>
                <legend>Targeted Delivery Dates, Labor Hours and Cycle Time</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="100%">
                  <tr>
                    <td class="form_label" valign="top">Scheduled Target:</td>
<?php
  $scheduled_completion_date_class="bold";
  $revised_completion_date_class="bold";
  if ($scheduled_completion_date!="TBD")
    {
      $mktime_now=mktime(0, 0, 0, date("m") ,date("d") ,date("Y"));
      if ($revised_completion_date=="0000-00-00")
        {
          $mktime_promise_date=mktime(0, 0, 0, substr($scheduled_completion_date,5,2), substr($scheduled_completion_date,8,2), substr($scheduled_completion_date,0,4));
          if ($mktime_promise_date <= $mktime_now) $scheduled_completion_date_class.=" red";
        }
      else
        {
          $mktime_promise_date=mktime(0, 0, 0, substr($revised_completion_date,5,2), substr($revised_completion_date,8,2), substr($revised_completion_date,0,4));
          if ($mktime_promise_date <= $mktime_now) $revised_completion_date_class.=" red";
        }
    }
?>
                    <td valign="top" class="<?php echo "$scheduled_completion_date_class";?>"><?php if ($scheduled_completion_date=="TBD") echo $scheduled_completion_date; else echo ReformatDate($scheduled_completion_date);?></td>
                    <td class="form_label" valign="top">Revised Target:</td>
                    <td valign="top" class="<?php echo "$revised_completion_date_class";?>"><?php echo ReformatDate($revised_completion_date);?></td>
                    <td class="form_label" valign="top">Override Target:</td>
                    <td nowrap valign="top">
<?php
  if ($disabled_attr)
    {
?>
                      <img alt="Override target is not allowed for closed ROs" src="images/icon_calendar.gif" border="0">
<?php
    }
  else
    {
?>
                      <a href="#" onClick="cal.select(document.forms['example'].override_date,'cal2','MM-dd-yyyy'); return false;" name="cal2" id="cal2"><img alt="Click to select date" src="images/icon_calendar.gif" border="0"></a> <input readonly class="borderless bold" type="text" name="override_date" value="<?php $override_date;?>" size="10" onchange="data_changed=true"></td>
<?php
    }
?>
                    <td class="form_label" valign="top">Actual Pick-Up:</td>
                    <td valign="top" class="bold">
<?php
  if ($vehicle_gone_date)
    {
      echo $vehicle_gone_date;
    }
  else
    {
      echo ReformatDate($date_closed);
    }
?>
                    </td>
                  </tr>
                  <tr>
<?php
	if ($lookup_shop_type=="P")
		{
?>
										<td class="form_label" valign="top">R&amp;I:</td>
										<td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_ri" size="4" maxlength="9" value="<?php echo $labor_hours_ri;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
										<td class="form_label" valign="top">Body:</td>
										<td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_body" size="4" maxlength="9" value="<?php echo $labor_hours_body;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
										<td class="form_label" valign="top">Paint:</td>
										<td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_paint" size="4" maxlength="9" value="<?php echo $labor_hours_paint;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
										<td class="form_label" valign="top">Trim:</td>
										<td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_trim" size="4" maxlength="9" value="<?php echo $labor_hours_trim;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
<?php
		}
	else
		{
?>
                    <td colspan="8">
                      <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="100%">
                        <tr>
                          <td class="form_label" valign="top">Body:</td>
                          <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_body" size="4" maxlength="9" value="<?php echo $labor_hours_body;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
                          <td class="form_label" valign="top">Paint:</td>
                          <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_paint" size="4" maxlength="9" value="<?php echo $labor_hours_paint;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
                          <td class="form_label" valign="top">Mechanical:</td>
                          <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_mech" size="4" maxlength="9" value="<?php echo $labor_hours_mech;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
                          <td class="form_label" valign="top">Trim:</td>
                          <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_trim" size="4" maxlength="9" value="<?php echo $labor_hours_trim;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
                          <td class="form_label" valign="top">Frame:</td>
                          <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_hours_frame" size="4" maxlength="9" value="<?php echo $labor_hours_frame;?>" onkeypress="return isNumberOrDecimalKey(event)" onchange="data_changed=true"></td>
                        </tr>
                      </table>
                    </td>
<?php
		}
?>
                  </tr>
                  <tr>
                    <td class="form_label" valign="top">Sublet:</td>
                    <td valign="top"><input <?php echo $disabled_attr;?> type="text" name="labor_sublet" size="4" maxlength="10" value="<?php echo $labor_sublet;?>" onKeyPress="return(currencyFormat(this,'','.',event))" onchange="data_changed=true"></td>
                    <td class="form_label" valign="top">Weekends/Holidays:</td>
                    <td valign="top">
                      <select <?php echo $disabled_attr;?> size="1" name="labor_weekends_holidays" onchange="data_changed=true">
<?php
  if ($labor_weekends_holidays==0)
    {
      echo "<option value=\"0\" selected>0</option>\n";
    }
  else
    {
      echo "<option value=\"0\">0</option>\n";
    }
  for ($i=1;$i<21;$i++)
    {
      if ($labor_weekends_holidays==$i)
        {
          echo "<option value=\"$i\" selected>$i</option>\n";
        }
      else
        {
          echo "<option value=\"$i\">$i</option>\n";
        }
    }
?>
                      </select>
                    </td>
                    <td class="form_label" valign="top">Target Cycle Time:</td>
                    <td valign="top">
                      <select <?php echo $disabled_attr;?> size="1" name="labor_cycle_time" onchange="data_changed=true">
<?php
  if ($labor_cycle_time==0) $labor_cycle_time=4;
  for ($i=1;$i<9;$i++)
    {
      if ($labor_cycle_time==$i)
        {
          echo "<option value=\"$i\" selected>$i</option>\n";
        }
      else
        {
          echo "<option value=\"$i\">$i</option>\n";
        }
    }
?>
                      </select>
                    </td>
                    <td class="form_label" valign="top">Actual Cycle Time:</td>
<?php
  $cycle_time_class="bold";
  if ($labor_actual_cycle_time!="TBD")
    {
      if ($labor_actual_cycle_time > $labor_cycle_time) $cycle_time_class.=" red";
    }
?>
                    <td valign="top" class="<?php echo $cycle_time_class;?>"><?php echo $labor_actual_cycle_time;?></td>
                  </tr>
<?php
  if ($original_status=="O" OR $status=="O")
    {
?>
                  <tr>
                    <td align="center" colspan="8" valign="top"><input type="submit" class="button smallest" value="Preview Targeted Delivery Date" name="preview_promise_date"> <input type="submit" class="button smallest" value="<?php echo $caption;?>" name="update_too"><td>
        					</tr>
<?php
		}
?>
                </table>
              </fieldset>
            </td>
          </tr>
          <tr>
            <td colspan="4" valign="top" width="100%">
              <fieldset>
                <legend>My Repair Status &#8482;</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="98%">
                  <tr>
                    <td valign="top" width="33%"><span class="blue bold">1. Repair Authorization</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C1_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C1_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C1_sub_step==1) { echo "<option value=\"1\" selected>Awaiting insurance authorization</option>"; } else { echo "<option value=\"1\">Awaiting insurance authorization</option>";}
					    if ($C1_sub_step==2) { echo "<option value=\"2\" selected>Awaiting customer authorization</option>"; } else { echo "<option value=\"2\">Awaiting customer authorization</option>";}
					    if ($C1_sub_step==3) { echo "<option value=\"3\" selected>Repair authorization obtained *</option>"; } else { echo "<option value=\"3\">Repair authorization obtained *</option>";}
					  ?>
                      </select>
                    </td>
                    <td valign="top" width="33%"><span class="blue bold">4. Paint Process</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C4_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C4_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C4_sub_step==1) { echo "<option value=\"1\" selected>Supplement hold *</option>"; } else { echo "<option value=\"1\">Supplement hold *</option>";}
					    if ($C4_sub_step==2) { echo "<option value=\"2\" selected>Parts hold</option>"; } else { echo "<option value=\"2\">Parts hold</option>";}
					    if ($C4_sub_step==3) { echo "<option value=\"3\" selected>Cut-In</option>"; } else { echo "<option value=\"3\">Cut-In</option>";}
					    if ($C4_sub_step==4) { echo "<option value=\"4\" selected>Working prep</option>"; } else { echo "<option value=\"4\">Working prep</option>";}
					    if ($C4_sub_step==5) { echo "<option value=\"5\" selected>Awaiting Paint</option>"; } else { echo "<option value=\"5\">Awaiting Paint</option>";}
					    if ($C4_sub_step==6) { echo "<option value=\"6\" selected>Working Paint *</option>"; } else { echo "<option value=\"6\">Working Paint *</option>";}
					    if ($C4_sub_step==7) { echo "<option value=\"7\" selected>Awaiting buff</option>"; } else { echo "<option value=\"7\">Awaiting buff</option>";}
					    if ($C4_sub_step==8) { echo "<option value=\"8\" selected>Working buff *</option>"; } else { echo "<option value=\"8\">Working buff *</option>";}
					    if ($C4_sub_step==9) { echo "<option value=\"9\" selected>Paint complete *</option>"; } else { echo "<option value=\"9\">Paint complete *</option>";}
					  ?>
                      </select>
                    </td>
                    <td valign="top" width="33%"><span class="blue bold">7. Clean-Up Process</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C7_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C7_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C7_sub_step==1) { echo "<option value=\"1\" selected>Awaiting clean-up</option>"; } else { echo "<option value=\"1\">Awaiting clean-up</option>";}
					    if ($C7_sub_step==2) { echo "<option value=\"2\" selected>Working clean-up *</option>"; } else { echo "<option value=\"2\">Working clean-up *</option>";}
					    if ($C7_sub_step==3) { echo "<option value=\"3\" selected>Clean-Up complete</option>"; } else { echo "<option value=\"3\">Clean-Up complete</option>";}
					  ?>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td valign="top" width="33%"><span class="blue bold">2. Parts</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C2_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C2_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C2_sub_step==1) { echo "<option value=\"1\" selected>Parts pre-order</option>"; } else { echo "<option value=\"1\">Parts pre-order</option>";}
					    if ($C2_sub_step==2) { echo "<option value=\"2\" selected>Parts hold</option>"; } else { echo "<option value=\"2\">Parts hold</option>";}
					    if ($C2_sub_step==3) { echo "<option value=\"3\" selected>Parts ordered</option>"; } else { echo "<option value=\"3\">Parts ordered</option>";}
					    if ($C2_sub_step==4) { echo "<option value=\"4\" selected>Parts received</option>"; } else { echo "<option value=\"4\">Parts received</option>";}
					  ?>
                      </select>
                    </td>
                    <td valign="top" width="33%"><span class="blue bold">5. Mechanical Process</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C5_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C5_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C5_sub_step==1) { echo "<option value=\"1\" selected>Supplement hold *</option>"; } else { echo "<option value=\"1\">Supplement hold *</option>";}
					    if ($C5_sub_step==2) { echo "<option value=\"2\" selected>Parts hold</option>"; } else { echo "<option value=\"2\">Parts hold</option>";}
					    if ($C5_sub_step==3) { echo "<option value=\"3\" selected>Awaiting mechanical</option>"; } else { echo "<option value=\"3\">Awaiting mechanical</option>";}
					    if ($C5_sub_step==4) { echo "<option value=\"4\" selected>Working mechanical *</option>"; } else { echo "<option value=\"4\">Working mechanical *</option>";}
					    if ($C5_sub_step==5) { echo "<option value=\"5\" selected>Awaiting suspension</option>"; } else { echo "<option value=\"5\">Awaiting suspension</option>";}
					    if ($C5_sub_step==6) { echo "<option value=\"6\" selected>Working suspension *</option>"; } else { echo "<option value=\"6\">Working suspension *</option>";}
					    if ($C5_sub_step==7) { echo "<option value=\"7\" selected>Mechanical complete</option>"; } else { echo "<option value=\"7\">Mechanical complete</option>";}
					  ?>
                      </select>
                    </td>
                    <td valign="top" width="33%"><span class="blue bold">8. QA Process</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C8_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C8_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C8_sub_step==1) { echo "<option value=\"1\" selected>Awaiting QA</option>"; } else { echo "<option value=\"1\">Awaiting QA</option>";}
					    if ($C8_sub_step==2) { echo "<option value=\"2\" selected>Working QA *</option>"; } else { echo "<option value=\"2\">Working QA *</option>";}
					    if ($C8_sub_step==3) { echo "<option value=\"3\" selected>QA Complete</option>"; } else { echo "<option value=\"3\">QA Complete</option>";}
					  ?>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td valign="top" width="33%"><span class="blue bold">3. Body Repair Process</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C3_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C3_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C3_sub_step==1) { echo "<option value=\"1\" selected>Disassembly *</option>"; } else { echo "<option value=\"1\">Disassembly *</option>";}
					    if ($C3_sub_step==2) { echo "<option value=\"2\" selected>Estimate Review</option>"; } else { echo "<option value=\"2\">Estimate Review</option>";}
					    if ($C3_sub_step==3) { echo "<option value=\"3\" selected>Supplement hold *</option>"; } else { echo "<option value=\"3\">Supplement hold *</option>";}
					    if ($C3_sub_step==4) { echo "<option value=\"4\" selected>Parts hold</option>"; } else { echo "<option value=\"4\">Parts hold</option>";}
					    if ($C3_sub_step==5) { echo "<option value=\"5\" selected>Awaiting metal</option>"; } else { echo "<option value=\"5\">Awaiting Metal</option>";}
					    if ($C3_sub_step==6) { echo "<option value=\"6\" selected>Working metal *</option>"; } else { echo "<option value=\"6\">Working Metal *</option>";}
					    if ($C3_sub_step==7) { echo "<option value=\"7\" selected>Body repair complete</option>"; } else { echo "<option value=\"7\">Body repair complete</option>";}
					  ?>
                      </select>
                    </td>
                    <td valign="top" width="33%"><span class="blue bold">6. Reassembly Process</span><br>
                      <select <?php echo $disabled_attr;?> size="1" name="C6_sub_step" style="width: 215px" onchange="data_changed=true">
					  <?php
					    if ($C6_sub_step==0) { echo "<option value=\"0\" selected>Select...</option>"; } else { echo "<option value=\"0\">Select...</option>";}
					    if ($C6_sub_step==1) { echo "<option value=\"1\" selected>Supplement hold *</option>"; } else { echo "<option value=\"1\">Supplement hold *</option>";}
					    if ($C6_sub_step==2) { echo "<option value=\"2\" selected>Parts hold</option>"; } else { echo "<option value=\"2\">Parts hold</option>";}
					    if ($C6_sub_step==3) { echo "<option value=\"3\" selected>Awaiting trim</option>"; } else { echo "<option value=\"3\">Awaiting Trim</option>";}
					    if ($C6_sub_step==4) { echo "<option value=\"4\" selected>Working trim *</option>"; } else { echo "<option value=\"4\">Working Trim *</option>";}
					    if ($C6_sub_step==5) { echo "<option value=\"5\" selected>Reassembly complete *</option>"; } else { echo "<option value=\"5\">Reassembly complete *</option>";}
					  ?>
                      </select>
                    </td>
                    <td valign="top" width="33%"><label for="status_c9"><span class="blue bold">9. Ready for Pick-Up * </span><input id="status_c9" <?php echo $disabled_attr;?> type="checkbox" class="checkbox" name="C9" value="X" <?php if ($C9=="X") echo "checked"; if ($repair_order_service_status_id[9]>0) echo " checked disabled";?> onclick="data_changed=true"></label>
<?php
  if ($ro_id)
    {
?>
                    <br><span class="blue bold">&nbsp;&nbsp;&nbsp;&nbsp;Car Gone Date </span>
<?php
  		if (status=="C")
  		  {
					echo $vehicle_gone_date;
  		  }
  		else
  		  {
?>
                    <a href="#" onClick="cal.select(document.forms['example'].vehicle_gone_date,'cal3','MM-dd-yyyy'); return false;" name="cal3" id="cal3"><img alt="Click to select date" src="images/icon_calendar.gif" border="0"></a> <input readonly class="borderless bold" type="text" name="vehicle_gone_date" value="<?php echo $vehicle_gone_date;?>" size="10" onchange="data_changed=true">
<?php
						if ($vehicle_gone_date && ($original_status=="O" OR $status=="O"))
							{
?>
										<br /><span class="red bold">&nbsp;&nbsp;&nbsp;&nbsp;<label for="remove_car_gone_date">Remove car gone date <input id="remove_car_gone_date" <?php echo $disabled_attr;?> type="checkbox" class="checkbox" name="remove_car_gone_date" value="X" <?php if ($remove_car_gone_date=="X") echo "checked";?> onclick="data_changed=true"></label></span>
<?php
							}
  		  }
    }
?>
                    </td>
                  </tr>
                  <tr>
                    <td align="center" colspan="3" valign="top" width="100%" class="smallest">A status notification will be automatically emailed to the Vehicle Owner for Items marked with an *</td>
                  </tr>
                </table>
              </fieldset>
            </td>
          </tr>
<?php
	if ($status=="O")
		{
?>
          <tr class="noprint">
            <td colspan="2" width="50%">
              <fieldset style="height: 120px">
                <legend>Service Advisor Notes</legend>
                  <textarea <?php echo $disabled_attr;?> rows="5" name="note" style="margin-left: 20px; margin-top: 5px; width: 93%;"><?php if (strlen($note)>0) echo $note;?></textarea>
              </fieldset>
            </td>
            <td colspan="2" width="50%">
              <fieldset style="height: 120px">
                <legend>Talk to Customer (Customer Message Center)</legend>
<?php
  if ($lookup_sms_allowed=="Y")
    {
?>
                  <textarea <?php echo $disabled_attr;?> rows="4" name="email_message" style="margin-left: 20px; margin-top: 5px; width: 93%;"><?php if ($email_message) echo $email_message;?></textarea>
                  <br><label for="send_text_message"><input id="send_text_message" <?php echo $disabled_attr;?> type="checkbox" class="checkbox" style="margin-left: 20px;" name="send_text_message" value="X" <?php if ($send_text_message=="X") echo "checked";?> onclick="data_changed=true"> <span class="blue bold smallest">Send as text message. NOTE: For best results limit text messages to 1 line.</span></label>
<?php
    }
  else
    {
?>
                  <textarea <?php echo $disabled_attr;?> rows="5" name="email_message" style="margin-left: 20px; margin-top: 5px; width: 93%;"><?php if ($email_message) echo $email_message;?></textarea>
<?php
    }
?>
              </fieldset>
            </td>
          </tr>
<?php
		}
?>
          <tr>
            <td colspan="4" width="100%">
              <fieldset>
                <legend>To Do List</legend>
                <table align="center" border="0" cellpadding="0" cellspacing="1" class="zebra_no_width">
                  <tr>
                    <th>To Do Item</th>
                    <th colspan="2">Status</th>
                    <th>Comment</th>
                  </tr>
                  <tr class="odd">
                    <td class="bold red">*Cycle Time Vehicle*</td>
<?php
          $checked="";
          if ($cycle_time_vehicle=="Y") $checked="checked";
          echo "<td><label for=\"cycle_time_vehicle_y\"><input id=\"cycle_time_vehicle_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"cycle_time_vehicle\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($cycle_time_vehicle=="N") $checked="checked";
          echo "<td><label for=\"cycle_time_vehicle_n\"><input id=\"cycle_time_vehicle_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"cycle_time_vehicle\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"cycle_time_vehicle_comment\" size=\"50\" value=\"$cycle_time_vehicle_comment\" onchange=\"data_changed=true\"></td>\n";
?>
                  </tr>
                  <tr class="even">
                    <td class="bold red">*FAST TRACK*</td>
<?php
          $checked="";
          if ($fast_track=="Y") $checked="checked";
          echo "<td><label for=\"fast_track_y\"><input id=\"fast_track_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"fast_track\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($fast_track=="N") $checked="checked";
          echo "<td><label for=\"fast_track_n\"><input id=\"fast_track_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"fast_track\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"fast_track_comment\" size=\"50\" value=\"$fast_track_comment\" onchange=\"data_changed=true\"></td>\n";
?>
                  </tr>
                  <tr class="odd">
                    <td class="bold red">*EOM*</td>
<?php
          $checked="";
          if ($eom=="Y") $checked="checked";
          echo "<td><label for=\"eom_y\"><input id=\"eom_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"eom\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($eom=="N") $checked="checked";
          echo "<td><label for=\"eom_n\"><input id=\"eom_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"eom\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"eom_comment\" size=\"50\" value=\"$eom_comment\" onchange=\"data_changed=true\"></td>\n";
?>
                  </tr>
                  <tr class="even">
                    <td class="bold red">*Hot File*</td>
<?php
          $checked="";
          if ($hot_file=="Y") $checked="checked";
          echo "<td><label for=\"hot_file_y\"><input id=\"hot_file_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"hot_file\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($hot_file=="N") $checked="checked";
          echo "<td><label for=\"hot_file_n\"><input id=\"hot_file_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"hot_file\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"hot_file_comment\" size=\"50\" value=\"$hot_file_comment\" onchange=\"data_changed=true\"></td>\n";
?>
                  </tr>
                  <tr class="odd">
                    <td class="bold red">*Hail Damage*</td>
<?php
          $checked="";
          if ($hail_damage=="Y") $checked="checked";
          echo "<td><label for=\"hail_damage_y\"><input id=\"hail_damage_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"hail_damage\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($hail_damage=="N") $checked="checked";
          echo "<td><label for=\"hail_damage_n\"><input id=\"hail_damage_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"hail_damage\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"hail_damage_comment\" size=\"50\" value=\"$hail_damage_comment\" onchange=\"data_changed=true\"></td>\n";
?>
                  </tr>
<?php
  $class="even";
  if ($lookup_customer_connect=="Y")
    {
?>
                  <tr class="even">
                    <td class="bold red">Multi-Point Inspection</td>
<?php
          $checked="";
          if ($multi_point_inspection=="Y") $checked="checked";
          echo "<td><label for=\"multi_point_inspection_y\"><input id=\"multi_point_inspection_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"multi_point_inspection\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($multi_point_inspection=="N") $checked="checked";
          echo "<td><label for=\"multi_point_inspection_n\"><input id=\"multi_point_inspection_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"multi_point_inspection\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"multi_point_inspection_comment\" size=\"50\" value=\"$multi_point_inspection_comment\" onchange=\"data_changed=true\"></td>\n";
?>
                  </tr>
<?php
      $class="odd";
    }
  else
    {
      $class="even";
    }
?>
                  <tr class="<?php echo $class;?>">
                    <td class="blue bold">Bumper Only Job</td>
<?php
          $checked="";
          if ($bumper_only_job=="Y") $checked="checked";
          echo "<td><label for=\"bumper_only_job_y\"><input id=\"bumper_only_job_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"bumper_only_job\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($bumper_only_job=="N") $checked="checked";
          echo "<td><label for=\"bumper_only_job_n\"><input id=\"bumper_only_job_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"bumper_only_job\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"bumper_only_job_comment\" size=\"50\" value=\"$bumper_only_job_comment\" onchange=\"data_changed=true\"></td>\n";

	if ($class=="even")
		{
			$class="odd";
		}
	else
		{
			$class="even";
		}
?>
                  </tr>
                  <tr class="<?php echo $class;?>">
                    <td class="blue bold">Re-Work</td>
<?php
          $checked="";
          if ($rework=="Y") $checked="checked";
          echo "<td><label for=\"rework_y\"><input id=\"rework_y\" $disabled_attr type=\"radio\" class=\"radio\" value=\"Y\" name=\"rework\" $checked onclick=\"data_changed=true\"> Yes</label></td>\n";
          $checked="";
          if ($rework=="N") $checked="checked";
          echo "<td><label for=\"rework_n\"><input id=\"rework_n\" $disabled_attr type=\"radio\" class=\"radio\" value=\"N\" name=\"rework\" $checked onclick=\"data_changed=true\"> No</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"rework_comment\" size=\"50\" value=\"$rework_comment\" onchange=\"data_changed=true\"></td>\n";
?>
                  </tr>
<?php
	if ($class=="even")
		{
			$class="odd";
		}
	else
		{
			$class="even";
		}
  $to_do_sql="SELECT * FROM vehicle_to_do WHERE shop_type='C' ORDER BY abbrev";
  $to_do_result=mysql_query($to_do_sql,$db) or die (mysql_error()."<br>29 SQL= ".$to_do_sql);
  if ($to_do_row=mysql_fetch_array($to_do_result))
    {
      $seq=1;
      do
        {
          $j=$to_do_row['id'];
          // $to_do_item=$to_do_row['to_do'];
          if ($to_do_row['abbrev']=='XOther')
          	{
							$to_do_item=$to_do_row['to_do'];
						}
          elseif ($to_do_row['abbrev'][0]=='*')
          	{
							$to_do_item="<span class=\"blue bold\">".$to_do_row['to_do']."</span>";
						}
					else
						{
          		$to_do_item=$to_do_row['abbrev'];
						}
          $checked="";
          echo "<tr class=\"$class\">\n";
          echo "<td>$to_do_item";
          if ($to_do_item=="Other") echo ": <input type=\"text\" $disabled_attr name=\"to_do_other_desc[$j]\" size=\"20\" value=\"$to_do_other_desc[$j]\" onchange=\"data_changed=true\">";
          echo "</td>\n";
          $checked="";
          if ($to_do_status[$j]=="O") $checked="checked";
          echo "<td><label for=\"to_do_status_o_$j\"><input id=\"to_do_status_o_$j\" $disabled_attr type=\"radio\" class=\"radio\" value=\"O\" name=\"to_do_status[$j]\" $checked onclick=\"data_changed=true\"> Open</label></td>\n";
          $checked="";
          if ($to_do_status[$j]=="C") $checked="checked";
          echo "<td><label for=\"to_do_status_c_$j\"><input id=\"to_do_status_c_$j\" $disabled_attr type=\"radio\" class=\"radio\" value=\"C\" name=\"to_do_status[$j]\" $checked onclick=\"data_changed=true\"> Closed</label></td>\n";
          echo "<td><input type=\"text\" $disabled_attr name=\"to_do_comment[$j]\" size=\"50\" value=\"$to_do_comment[$j]\" onchange=\"data_changed=true\"></td>\n";
          echo "</tr>\n";
          $seq++;
          if ($class=="even")
            {
              $class="odd";
            }
          else
            {
              $class="even";
            }
        } while ($to_do_row=mysql_fetch_array($to_do_result));
    }
?>
                </table>
              </fieldset>
            </td>
          </tr>
          <tr class="noprint">
            <td colspan="4" width="100%">
              <fieldset>
                <legend>Actions Available</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="98%">
                  <tr>
                    <td align="center" valign="top" width="100%">
<?php
  if ($ro_id>0)
    {
?>
                      <span class="smallest">Scroll down to view all My Repair Notes &#8482;
</span><br>&nbsp;<br>
<?php
    }
?>
                      <input type="submit" class="button" value="<?php echo $caption;?>" name="update">
                      <input type="submit" class="button" value="Open RO List" name="list_opened" onclick="if (data_changed) return confirm('Are you sure you want to leave this page? All changes will be lost.');">
                      <input type="submit" class="button" value="Closed RO List" name="list_closed" onclick="if (data_changed) return confirm('Are you sure you want to leave this page? All changes will be lost.');">
<?php
/*------------------------------------------------------------------------------------------------*
 * 2Q 2007 Change: If a manager is logged on provide a delete function if an RO is being updated. *
 *------------------------------------------------------------------------------------------------*/
  if (($lookup_user_is_admin=="Y") && ($caption=="Update"))
    {
      $confirm_message="'Are you sure you want to delete this RO? Click OK to delete the RO. Click Cancel to return to the RO page without deleting this RO.'";
      echo "<input type=\"submit\" value=\"Delete\" name=\"delete_ro\" class=\"delete_button\" onClick=\"javascript:return confirm($confirm_message)\"> \n";
    }
?>
                    </td>
                  </tr>
                </table>
              </fieldset>
            </td>
          </tr>
<?php
  if ($ro_id>0)
    {
?>
          <tr>
            <td colspan="4" valign="top" width="100%">
              <fieldset>
		        <legend>My Repair Notes &#8482;</legend>
                <table align="center" border="0" cellpadding="2" cellspacing="4" style="border-collapse: collapse" width="100%">
                  <tr>
                    <td align="center" colspan="4" valign="top" width="100%"><span class="bold"><span class="red">Message from Customer</span> | <span class="green">Message to Customer</span> | <span class="black">Service Advisor Note</span> | <span class="gray">Part Manager Note</span> | <span class="blue">Auto Status Note</span> | <span class="red">Message from Insurance</span><?php if ($lookup_customer_connect=="Y") echo " | <span class=\"purple\">Message from <i>Lead Tracker</i></span>";?></span></td>
                  </tr>
                  <tr>
                    <td colspan="4" valign="top" width="100%">
<?php
      $sql="SELECT * FROM repair_order_history WHERE (repair_order_id=$ro_id) AND (type!='F') AND (type!='Q') ORDER BY id DESC";
      $result=mysql_query($sql,$db) or die (mysql_error()."<br>30 SQL= ".$sql);
      if ($row=mysql_fetch_array($result))
        {
          echo "<table align=\"center\" border=\"0\" cellpadding=\"2\" cellspacing=\"4\" style=\"border-collapse: collapse\" width=\"100%\">\n";
          $prev_date=substr($row['date_added'],5,2) . "-" . substr($row['date_added'],8,2) . "-" . substr($row['date_added'],0,4);
          do
            {
              $date_added=$row['date_added'];
              $date=substr($date_added,5,2)."-".substr($date_added,8,2)."-".substr($date_added,0,4);
              $date_time=date("m-d-y g:i a", mktime(substr($date_added,11,2), substr($date_added,14,2), 0, substr($date_added,5,2), substr($date_added,8,2), substr($date_added,0,4)));
              $date_time.=" CT";
              $type=$row['type'];
              $note=$row['note'];
              $note_id=$row["id"];

							$user_id=$row["last_update_user_id"];
							if ($type=="C")
								{
									$name="CUSTOMER";
								}
							elseif ($user_id > 0)
								{
									$last_update_table=$row["last_update_table"];
									if ($last_update_table=="body")
										{
											$user_sql="SELECT first_name AS user_first_name, last_name AS user_last_name FROM service_provider_body_tech WHERE id=$user_id LIMIT 1";
										}
									elseif ($last_update_table=="mech")
										{
											$user_sql="SELECT first_name AS user_first_name, last_name AS user_last_name FROM service_provider_mech_tech WHERE id=$user_id LIMIT 1";
										}
									elseif ($last_update_table=="paint")
										{
											$user_sql="SELECT first_name AS user_first_name, last_name AS user_last_name FROM service_provider_paint_tech WHERE id=$user_id LIMIT 1";
										}
									elseif ($last_update_table=="trim")
										{
											$user_sql="SELECT first_name AS user_first_name, last_name AS user_last_name FROM service_provider_trim_tech WHERE id=$user_id LIMIT 1";
										}
									elseif (($type=="L") OR ($last_update_table=="super")) // Call center OR super user
										{
											$user_sql="SELECT name AS user_first_name, '' AS user_last_name FROM service_provider_super_user WHERE id=$user_id LIMIT 1";
										}
									else
										{
											$user_sql="SELECT user_first_name, user_last_name FROM user WHERE user_id=$user_id LIMIT 1";
										}
									$user_result=mysql_query($user_sql,$db) or die (mysql_error()."<br>31 SQL= ".$user_sql);
									if ($user_row=mysql_fetch_array($user_result))
										{
											$name=$user_row["user_first_name"]." ".$user_row["user_last_name"];
										}
									else
										{
											$name="$last_update_table ($user_id)";
										}
								}
							else
								{
									if ($type=="E")
										{
											$name="-SYSTEM-";
										}
									elseif ($type=="S") // CUSTOMER SIGNED ON
										{
											$name="CUSTOMER";
										}
									elseif ($type=="I") // INSURANCE
										{
											$name="-INS CO-";
										}
									else
										{
											$name="-- SHOP--";
										}
								}
							$note_class="";
							if ($type=="A") $note_class=" class=\"blue\"";
							if ($type=="B") $note_class=" class=\"gray\"";
							if ($type=="C") $note_class=" class=\"red\"";
							if ($type=="E") $note_class=" class=\"green\"";
							if ($type=="I") $note_class=" class=\"red\"";
							if ($type=="L") $note_class=" class=\"purple\"";
							if ($type=="M") $note_class=" class=\"black\"";
							if ($type=="P") $note_class=" class=\"red\"";
							if ($type=="Q") $note_class=" class=\"blue\""; // Parts auto note
							if ($type=="O") $note_class=" class=\"blue\"";
							if ($type=="S") $note_class=" class=\"red\"";
							$id="";
//							if (BannedWordFound($note))
//								{
//									$id="banned_".$note_id;
//									$note_class=" class=\"red_reverse\"";
//									$note=BannedWordHighlighted($note);
//								}
							if ($date!=$prev_date)
								{
									$prev_date=$date;
									echo "<tr>\n";
									echo "<td valign=\"top\" colspan=\"2\"><hr></td>\n";
									echo "</tr>\n";
								}
							echo "<tr>\n";
							echo "<td valign=\"top\" $note_class nowrap width=\"10%\"><b>$date_time<br>by $name</b></td>\n";
							echo "<td valign=\"top\" $note_class width=\"90%\">";
							if ($id)
								{
									echo "This note contains banned words. <a href=\"#$id\" class=\"Fsp.Reveal\">Click here</a> to view the note. Click again to hide the note.<br />";
									echo "<div id=\"$id\">$note</div>";
								}
							else
								{
									echo $note;
								}
							// $note
							echo "</td>\n";
							echo "</tr>\n";
            } while ($row=mysql_fetch_array($result));
          echo "</table>\n";
        }
      else
        {
          echo "<p align=\"center\"><span class=\"bold\">*** NO REPAIR NOTES ***</span></p>\n";
        }
?>
                    </td>
                  </tr>
                </table>
              </fieldset>
            </td>
          </tr>
<?php
    }
?>
        </table>
<?php
    }
include "includes/footer.php";
?>